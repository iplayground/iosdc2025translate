1
00:00:09,180 --> 00:00:11,260
歡迎來到 Track D

2
00:00:12,700 --> 00:00:13,880
我叫 Chris

3
00:00:13,880 --> 00:00:15,375
請多多指教

4
00:00:15,983 --> 00:00:19,900
我是美國人，但已經在日本住了 8 年

5
00:00:21,317 --> 00:00:26,180
我曾在紐約一家叫 Timehop 的
社群網路新創公司工作

6
00:00:26,180 --> 00:00:29,300
在 Cookpad 工作了 6 年

7
00:00:30,250 --> 00:00:34,140
從那之後我個人開發了各種 app

8
00:00:34,140 --> 00:00:37,840
在 App Store 上販售

9
00:00:40,580 --> 00:00:44,500
最近正在開發一款叫做
「駅ライブ」 (Eki Live) 的 app

10
00:00:44,500 --> 00:00:48,500
今天要談談駅 Live 的一部分

11
00:00:50,980 --> 00:00:55,020
什麼是列車路線追蹤演算法呢

12
00:00:55,780 --> 00:01:01,600
搭電車時，知道下一站很方便吧

13
00:01:03,230 --> 00:01:07,400
在電車內會看車內資訊顯示器

14
00:01:07,400 --> 00:01:14,820
或聽列車廣播、車內廣播

15
00:01:17,230 --> 00:01:22,260
但如果這些資訊
能顯示在動態島 (Dynamic Island) 上會更方便吧

16
00:01:26,020 --> 00:01:30,960
在發表中，首先會整理演算法所需的資料

17
00:01:30,960 --> 00:01:37,080
接著實作各個部分，並逐步改善

18
00:01:40,580 --> 00:01:44,960
演算法需要兩種類型的資料：

19
00:01:46,530 --> 00:01:50,960
路線的靜態資料與即時 GPS 資料

20
00:01:53,030 --> 00:01:57,980
路線定義為車站的有序列表

21
00:01:59,520 --> 00:02:06,420
在這個例子中，港未來線由 6 個車站組成

22
00:02:10,500 --> 00:02:14,840
在路線上，列車雙向運行

23
00:02:14,840 --> 00:02:26,240
鐵路的實際路線，可以用座標點的排列來表示

24
00:02:28,840 --> 00:02:35,320
這張地圖顯示了這次使用的路線資料

25
00:02:39,930 --> 00:02:46,160
使用 CoreLocation
從 iPhone 即時取得位置資訊

26
00:02:46,160 --> 00:02:53,000
該資料儲存在裝置內的 SQLite 中

27
00:02:55,360 --> 00:03:00,900
位置資訊包含 CLLocation 的所有資訊

28
00:03:00,900 --> 00:03:07,180
移動、經度、速度、行進方向、精度等

29
00:03:09,300 --> 00:03:12,960
工作階段（Session）是位置資訊的實驗序列清單

30
00:03:12,960 --> 00:03:17,040
工作階段代表可能的路線

31
00:03:20,320 --> 00:03:25,720
為了將原始資料視覺化
我製作了 macOS app

32
00:03:28,100 --> 00:03:31,300
側邊欄有工作階段的清單

33
00:03:33,900 --> 00:03:40,040
下方面板則有所選工作階段的位置資訊時間序列清單

34
00:03:42,480 --> 00:03:48,760
目的是建立能夠推估這些資訊的演算法

35
00:03:49,880 --> 00:03:54,220
像是路線、行進方向、下一站

36
00:03:57,080 --> 00:04:00,220
這是系統的整體架構

37
00:04:01,450 --> 00:04:07,630
app 會將來自 CoreLocation 的
位置資訊依序傳送給演算法

38
00:04:09,600 --> 00:04:14,250
演算法會計算出新的結果

39
00:04:14,950 --> 00:04:21,140
這個結果會用來更新 app 的
使用者介面和即時動態 (Live Activity)

40
00:04:24,000 --> 00:04:27,660
首先，讓我們只關注一個定位點

41
00:04:27,660 --> 00:04:31,580
假設我們正在搭乘東橫線

42
00:04:31,580 --> 00:04:36,800
在綱島站附近記錄了這個定位點

43
00:04:38,400 --> 00:04:43,050
光憑這一個定位點就能推測出路線嗎

44
00:04:45,230 --> 00:04:48,700
我們有鐵路的座標點清單

45
00:04:52,930 --> 00:04:59,220
針對每條路線
找出與這個定位點最接近的鐵路座標

46
00:04:59,220 --> 00:05:02,680
然後按照距離排序

47
00:05:04,850 --> 00:05:06,950
結果如下

48
00:05:09,600 --> 00:05:16,340
最接近的是東橫線的座標，距離約 12 公尺

49
00:05:18,730 --> 00:05:20,380
完成了

50
00:05:22,050 --> 00:05:24,480
謝謝大家

51
00:05:25,480 --> 00:05:32,580
不過讓我們來看看東橫線的另一個位置點

52
00:05:34,630 --> 00:05:41,740
在這個區域，東橫線與目黑線的軌道是平行的

53
00:05:42,780 --> 00:05:49,140
但僅憑這一個位置點，無法確定是哪條路線

54
00:05:51,830 --> 00:05:56,500
演算法會使用路線上的所有位置點來進行推估

55
00:05:57,220 --> 00:06:04,280
在這個例子中，沿著東橫線的空間比目黑線更長

56
00:06:08,730 --> 00:06:16,420
首先，將這個位置點
與最近的軌道座標之間的距離轉換為分數

57
00:06:16,420 --> 00:06:25,040
越近分數越高，越遠則呈指數下降

58
00:06:26,520 --> 00:06:31,180
然後將這些分數在時間方向上累加起來

59
00:06:35,130 --> 00:06:41,560
東橫線的累積分數比目黑線還要高

60
00:06:41,560 --> 00:06:44,460
完成了

61
00:06:48,550 --> 00:06:57,140
不過讓我們來看第三個定位點

62
00:06:59,080 --> 00:07:06,300
這是在東京東側幹線
京濱東北線的車內記錄的

63
00:07:10,280 --> 00:07:15,060
東海道線與京濱東北線平行運行

64
00:07:17,680 --> 00:07:22,140
但是東海道線會通過許多車站

65
00:07:26,150 --> 00:07:31,260
如果只以比較距離來評分的話，分數會相同

66
00:07:35,260 --> 00:07:45,180
那有通過車站時就稍微扣分吧
在站與站之間停車時也稍微扣分

67
00:07:49,130 --> 00:07:53,750
這樣京濱東北線的分數就會稍微高一些

68
00:07:56,080 --> 00:08:05,940
為了觀察扣分機制（懲罰值）的影響
讓我們來看兩個路線的例子

69
00:08:07,350 --> 00:08:10,440
首先，案例一，從東京站出發

70
00:08:12,800 --> 00:08:17,320
電車停靠在京濱東北線的第二站

71
00:08:19,420 --> 00:08:28,760
東海道線這邊因為是在站與站之間停車
所以分數會被扣分

72
00:08:30,700 --> 00:08:37,740
接下來，東海道線這邊的懲罰值會不斷累積

73
00:08:37,740 --> 00:08:42,140
演算法判斷結果為京濱東北線

74
00:08:43,730 --> 00:08:44,540
案例二

75
00:08:49,420 --> 00:08:54,200
電車通過京濱東北線的第二站

76
00:08:56,020 --> 00:09:00,700
所以京濱東北線這邊的分數會被扣分

77
00:09:00,700 --> 00:09:02,660
接下來

78
00:09:03,800 --> 00:09:07,160
京濱東北線這邊的懲罰值會不斷累積

79
00:09:07,160 --> 00:09:10,260
判斷結果為東海道線

80
00:09:12,680 --> 00:09:14,500
完成了

81
00:09:18,330 --> 00:09:21,520
還有很多這樣的案例

82
00:09:22,930 --> 00:09:25,180
先繼續往下進行吧

83
00:09:26,600 --> 00:09:32,950
針對兩個方向的路線
推估列車的行進方向

84
00:09:34,100 --> 00:09:37,680
每條路線都有兩個方向

85
00:09:39,700 --> 00:09:45,680
車站的發車資訊會分成上行和下行，對吧

86
00:09:48,500 --> 00:09:52,600
在東橫線，往澀谷方向是上行

87
00:09:52,600 --> 00:09:56,130
往橫濱方向是下行

88
00:09:58,830 --> 00:10:04,680
讓我們來看看在東橫線往澀谷方向記錄的位置資訊

89
00:10:08,260 --> 00:10:14,900
在停靠兩站的時間點，比較停靠的時間序列

90
00:10:15,725 --> 00:10:25,180
如果與資料庫中的車站排列順序一致
就判定行進方向為遞增（Ascending）

91
00:10:27,680 --> 00:10:32,820
先停靠菊名站，之後停靠大倉山站

92
00:10:39,800 --> 00:10:43,420
也就是往澀谷方向

93
00:10:44,850 --> 00:10:46,630
完成了

94
00:10:49,780 --> 00:10:57,980
不過判定過程有時接近五分鐘呢

95
00:10:59,480 --> 00:11:02,620
那麼應該可以做得更好吧

96
00:11:04,430 --> 00:11:08,900
那我們再多用 CLLocation 的 course 屬性
來取得行進方向（航向）

97
00:11:11,330 --> 00:11:16,860
CoreLocation 會以度數
回傳 iPhone 的行進方向

98
00:11:19,630 --> 00:11:24,280
0 度是北方，180 度是南方

99
00:11:25,800 --> 00:11:30,860
要注意的是，我們這裡用的
並不是指南針的方位朝向 (Heading)

100
00:11:30,860 --> 00:11:41,300
範例位置的行進方向是 359.6 度

101
00:11:41,300 --> 00:11:43,700
幾乎是朝北的

102
00:11:43,700 --> 00:11:50,180
首先從這個位置找出最近的兩個車站

103
00:11:55,480 --> 00:11:59,350
接著配合資料庫的升序 (Ascending)

104
00:11:59,400 --> 00:12:03,640
計算出兩站之間的方向向量

105
00:12:04,650 --> 00:12:09,600
在東橫線中，升序的方向是下行

106
00:12:11,700 --> 00:12:17,400
所以向量是從綱島到大倉山的方向

107
00:12:20,825 --> 00:12:23,400
還記得內積嗎

108
00:12:26,020 --> 00:12:31,340
單純用內積就能比較向量的方向

109
00:12:32,680 --> 00:12:36,540
同方向為正，反方向為負

110
00:12:40,230 --> 00:12:42,580
接下來計算內積

111
00:12:50,450 --> 00:12:55,120
如果內積為正
行進方向就是遞增(Ascending)

112
00:12:55,120 --> 00:12:58,100
如果為負
就是遞減(Descending)

113
00:13:00,080 --> 00:13:05,000
計算出的內積是負 0.95

114
00:13:05,000 --> 00:13:08,880
結果是負值，判定為遞減

115
00:13:09,900 --> 00:13:17,100
在資料庫中，遞減對應到東橫線的上行

116
00:13:17,100 --> 00:13:20,680
所以是往澀谷方向前進

117
00:13:23,100 --> 00:13:25,330
完成了

118
00:13:27,450 --> 00:13:30,980
進入演算法的最後一個部分吧

119
00:13:32,650 --> 00:13:37,220
終於可以推估目前的車站了

120
00:13:38,125 --> 00:13:43,860
車內的資訊顯示器會顯示下一站對吧

121
00:13:46,330 --> 00:13:54,780
每個車站會依序切換
「下一站」、「即將到站」、「現在停靠」這些階段

122
00:13:59,300 --> 00:14:05,700
在地圖上，各階段分別顯示在這些位置

123
00:14:09,030 --> 00:14:15,380
計算從定位點到最近車站的距離與方向向量

124
00:14:17,050 --> 00:14:18,480
這是「下一站：川崎」的示意圖

125
00:14:18,480 --> 00:14:21,880
再來是「即將到站」、「現在停靠」

126
00:14:21,880 --> 00:14:25,280
這是「下一站：蒲田」的示意圖

127
00:14:25,280 --> 00:14:29,300
因為前一站（川崎）已經不在行進方向上

128
00:14:30,230 --> 00:14:35,640
所以「下一站」顯示的就不會是前一站（川崎）

129
00:14:35,640 --> 00:14:38,340
而是蒲田站

130
00:14:40,700 --> 00:14:42,520
啊沒事，不用理沒關係

131
00:14:44,800 --> 00:14:47,880
雖然完成了

132
00:14:47,880 --> 00:14:52,020
但只靠 GPS 不夠穩定

133
00:14:54,320 --> 00:14:56,600
那這次就來做車站的歷程紀錄吧

134
00:14:57,950 --> 00:15:05,460
針對每個車站
根據車站間的距離和行進方向來分類位置資訊

135
00:15:08,630 --> 00:15:14,160
圖中顯示的是接近中 (Approaching)
停靠中 (Visiting)
首次離站 (First Departure) 的位置資訊

136
00:15:16,930 --> 00:15:20,740
焦點車站階段 (Focus Station Phase)
的演算法分為三個步驟

137
00:15:22,230 --> 00:15:28,960
步驟 1：如果位置在車站範圍內
就分類為「正在停靠」或「接近中」

138
00:15:32,080 --> 00:15:39,140
如果位置在車站範圍外
就將該位置設定為「首次離站位置」

139
00:15:40,930 --> 00:15:44,500
步驟 2：使用車站的歷程記錄

140
00:15:44,500 --> 00:15:46,940
來判定車站階段

141
00:15:49,980 --> 00:15:55,520
這是北千住站「接近中」的車站階段

142
00:15:57,550 --> 00:15:59,580
「正在停靠」階段

143
00:15:59,580 --> 00:16:02,560
「已停靠」階段

144
00:16:05,620 --> 00:16:13,340
步驟 3：在車站的階段歷程記錄中搜尋
以判定焦點階段

145
00:16:15,980 --> 00:16:27,280
例如，川崎站的最新階段是「已停靠」
那麼焦點階段就是「下一站：蒲田」

146
00:16:29,640 --> 00:16:38,240
例如，武藏小杉站的最新階段是「已停靠」
而元住吉站正在接近的話

147
00:16:39,880 --> 00:16:43,280
焦點階段就是「即將抵達元住吉」

148
00:16:45,600 --> 00:16:50,180
使用狀態機 (State Machine) 的話
結果會更加穩定

149
00:16:51,700 --> 00:16:53,680
完成了

150
00:16:54,950 --> 00:16:56,640
最後的完成了

151
00:16:58,640 --> 00:17:02,540
最後來展示開發的 macOS app

152
00:17:04,700 --> 00:17:10,740
我們來看京濱東北線從關內到川崎的乘車過程

153
00:17:12,500 --> 00:17:19,240
演算法處理所有位置資訊比較花時間

154
00:17:19,240 --> 00:17:23,540
所以這裡用 10 倍速播放

155
00:17:32,980 --> 00:17:37,280
在檢閱器 (Inspector) 中
可以看到演算法的判斷結果

156
00:17:37,280 --> 00:17:41,780
例如京濱東北線的分數最高

157
00:17:44,800 --> 00:17:49,900
行進方向是「大宮方向，北行」

158
00:17:52,200 --> 00:17:55,660
也可以看到各站的最新焦點階段

159
00:18:00,480 --> 00:18:06,040
選擇最後的位置資訊
就能看到整體的車站階段歷程

160
00:18:06,040 --> 00:18:14,780
點擊車站的階段，就能看到車站階段歷程

161
00:18:14,780 --> 00:18:22,640
選擇車站，地圖上就會顯示分類後的位置資訊

162
00:18:27,030 --> 00:18:31,140
為了取得資料，我製作了五個 app

163
00:18:31,140 --> 00:18:36,060
已在 GitHub 上以開源形式公開

164
00:18:37,580 --> 00:18:40,900
macOS app 和演算法都有

165
00:18:49,450 --> 00:18:53,740
請試用看看駅 Live 這個 app

166
00:18:54,825 --> 00:19:03,520
app 會在背景自動啟動
並在動態島（Dynamic Island）上顯示路線與下一站

167
00:19:08,230 --> 00:19:10,160
今天早上我也用了這個 app

168
00:19:11,225 --> 00:19:13,540
這個 app 真不錯

169
00:19:16,830 --> 00:19:18,700
我正在找工作

170
00:19:18,700 --> 00:19:23,080
如果有想一起工作的人，請務必聯絡我

171
00:19:24,130 --> 00:19:27,533
我的演講到此結束
謝謝大家

172
00:19:32,000 --> 00:19:33,730
好的，謝謝 Chris

173
00:19:33,730 --> 00:19:35,960
那麼接下來我們要進入問答環節

174
00:19:35,960 --> 00:19:38,740
有問題或意見的人請舉手

175
00:19:42,760 --> 00:19:43,983
好的，轉交下一位

176
00:19:46,750 --> 00:19:47,740
感謝您的發表

177
00:19:50,650 --> 00:19:53,060
請問您大概搭了幾次電車呢

178
00:19:56,900 --> 00:19:58,900
搭了幾次電車呢

179
00:19:59,700 --> 00:20:00,194
幾次？

180
00:20:00,240 --> 00:20:07,960
為了製作和驗證這個 app
您搭了多少次電車呢

181
00:20:10,480 --> 00:20:13,520
兩個月⋯⋯

182
00:20:15,250 --> 00:20:17,840
持續了兩個月、三個月左右

183
00:20:17,840 --> 00:20:18,740
是每天都去搭車嗎

184
00:20:18,740 --> 00:20:20,380
是也不到每天

185
00:20:20,380 --> 00:20:22,840
啊，不過也快差不多了

186
00:20:22,840 --> 00:20:25,640
也就是說搭了超過 100 次了吧

187
00:20:25,640 --> 00:20:26,600
謝謝您

188
00:20:27,650 --> 00:20:29,400
那麼，下一位

189
00:20:29,400 --> 00:20:32,860
第三排後面的那位

190
00:20:40,550 --> 00:20:55,340
在開發的過程中，到目前為止
您是否還有覺得能改進或再完善的地方呢

191
00:20:58,830 --> 00:21:00,500
唔，這不太好說明

192
00:21:02,200 --> 00:21:04,180
能改到 Ask the Speaker 時段討論嗎

193
00:21:04,180 --> 00:21:06,440
好的，沒問題

194
00:21:06,440 --> 00:21:07,640
不好意思

195
00:21:08,580 --> 00:21:10,230
謝謝

196
00:21:10,230 --> 00:21:13,780
還有其他人嗎

197
00:21:17,350 --> 00:21:18,260
好的

198
00:21:18,260 --> 00:21:20,040
那麼下一位

199
00:21:21,850 --> 00:21:24,020
感謝您的發表

200
00:21:24,020 --> 00:21:28,000
在東京的車站當中，最困難的

201
00:21:28,000 --> 00:21:30,780
有沒有判定起來比較困難的車站呢

202
00:21:32,780 --> 00:21:35,200
再說一次，最困難的？

203
00:21:35,200 --> 00:21:41,920
最難判別下一站的車站是哪一個呢
像是路線之類的

204
00:21:43,830 --> 00:21:46,780
最難的路線？

205
00:21:46,780 --> 00:21:51,380
是的，像是多路線交會的車站
會很難判斷路線嗎

206
00:22:01,480 --> 00:22:05,200
依路線而異，有些比較困難

207
00:22:05,200 --> 00:22:12,800
像有些路線會從地下到地上

208
00:22:12,800 --> 00:22:21,580
GPS 的精度會改變，所以就很困難

209
00:22:21,580 --> 00:22:25,560
關於 GPS 的精度

210
00:22:25,560 --> 00:22:33,060
像是川崎站這樣的大站
有很多天花板

211
00:22:33,060 --> 00:22:37,980
GPS 訊號馬上就會變差

212
00:22:40,256 --> 00:22:41,200
謝謝

213
00:22:41,824 --> 00:22:46,200
那麼接下來大概是最後的提問

214
00:22:49,320 --> 00:22:51,600
感謝您的發表

215
00:22:51,600 --> 00:22:57,580
開著 app 在追蹤車站的時候
感覺上會很耗電

216
00:22:57,580 --> 00:23:02,560
如果是這樣的話
能請您分享有什麼降低耗電的方式嗎

217
00:23:02,560 --> 00:23:04,620
電池的影響？

218
00:23:09,450 --> 00:23:19,840
實際使用的狀況下
耗電量大概跟音樂 app 差不多

219
00:23:19,840 --> 00:23:32,540
例如使用一天後
確認所有 app 的耗電百分比

220
00:23:32,540 --> 00:23:36,480
確認之後大約用掉 7% 電量

221
00:23:36,480 --> 00:23:47,800
搭電車的時候，一邊聽音樂
同時讓駅ライブ app 在背景運作

222
00:23:47,800 --> 00:23:53,640
耗電量差不多，但希望能逐漸改善

223
00:23:53,640 --> 00:23:58,540
意思是耗電量跟音樂 app 差不多嗎

224
00:23:58,540 --> 00:23:59,580
謝謝

225
00:24:00,780 --> 00:24:01,500
謝謝

226
00:24:01,500 --> 00:24:05,950
那麼接下來是最後一個問題，剛才舉手的那位

227
00:24:07,500 --> 00:24:10,500
啊，在那邊

228
00:24:12,030 --> 00:24:14,500
我用英文提問

229
00:24:14,500 --> 00:24:19,500
您今天展示的演算法真的很棒

230
00:24:19,500 --> 00:24:25,380
這個演算法是否類似於⋯⋯我想問的是

231
00:24:27,250 --> 00:24:38,500
這個演算法是否與 Apple 地圖或 Google 地圖
使用類似的模式來追蹤列車動態

232
00:24:38,500 --> 00:24:45,530
我不太確定，他們可能用了更進階的技術
因為我認為他們是在伺服器端運行的

233
00:24:45,530 --> 00:24:51,500
有一種叫做航位推測法（Dead reckoning）的技術
這次沒有機會深入探討

234
00:24:51,500 --> 00:25:00,500
意思是它會根據過去的 GPS 位置
持續預測下一個 GPS 位置

235
00:25:00,500 --> 00:25:07,050
當精度降低時，你就持續預測下一個點
這涉及很多數學運算

236
00:25:07,050 --> 00:25:10,900
我還沒有做到這一步
這個演算法目前還是相對單純

237
00:25:10,900 --> 00:25:15,900
我發現一個一個，逐步修補問題比較容易

238
00:25:15,900 --> 00:25:22,100
並找出困難點在哪裡
直到我們必須重新改寫為止

239
00:25:22,100 --> 00:25:27,300
有時會在沒有 GPS 訊號的時候
用 Google 地圖，對吧

240
00:25:27,300 --> 00:25:32,900
但它仍然會預測你目前所在的下一個位置

241
00:25:32,900 --> 00:25:36,100
請問你知道那是怎麼運作的嗎

242
00:25:36,100 --> 00:25:46,600
嗯，我不太確定是哪個功能
你是說像是已經設定行程，正在導航的時候嗎

243
00:25:46,600 --> 00:25:54,040
喔，就像是你正在用導航
可是人正好在隧道裡的時候

244
00:25:54,040 --> 00:25:59,500
雖然沒有 GPS 訊號
但它仍然知道你目前位置，以及下一個目的地

245
00:25:59,500 --> 00:26:03,500
請問你知道那是怎麼運作的嗎

246
00:26:03,500 --> 00:26:07,500
我想就是我剛才提到的
航位推測法 (Dead reckoning)

247
00:26:07,500 --> 00:26:12,500
它就是持續進行預測

248
00:26:12,500 --> 00:26:19,500
因為裝置只能取得一定數量的資料
所以他們必須利用現有的資料來做些什麼

249
00:26:19,500 --> 00:26:21,500
謝謝

250
00:26:21,500 --> 00:26:23,500
好的，謝謝

251
00:26:23,500 --> 00:26:27,500
那麼，時間到了
Q&A 環節就到此結束

252
00:26:27,500 --> 00:26:29,920
接下來是一分鐘的意見回饋時間

253
00:26:29,920 --> 00:26:45,033
翻譯：@dannypang1113
校對：@Mori_Liu

