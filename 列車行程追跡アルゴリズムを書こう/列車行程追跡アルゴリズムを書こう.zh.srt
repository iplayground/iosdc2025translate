1
00:00:06,480 --> 00:00:08,560
歡迎到 Track D

2
00:00:08,560 --> 00:00:11,179
我叫 Chris

3
00:00:11,179 --> 00:00:12,439
請多多指教

4
00:00:12,439 --> 00:00:17,199
我是美國人，但已經在日本住了 8 年

5
00:00:17,199 --> 00:00:23,480
我曾在紐約一家叫 Tumblr 的社群網路新創公司工作

6
00:00:23,480 --> 00:00:26,600
在 Cookpad 工作了 6 年

7
00:00:27,775 --> 00:00:31,440
從那之後我個人開發了各種App

8
00:00:31,440 --> 00:00:35,140
在 App Store 上販售

9
00:00:37,875 --> 00:00:41,800
最近正在開發一款叫做「駅ライブ」(Eki Live) 的App

10
00:00:41,799 --> 00:00:45,799
今天要談談駅Live的一部分。

11
00:00:48,275 --> 00:00:52,320
什麼是列車路線追蹤演算法呢？

12
00:00:53,080 --> 00:00:58,900
搭電車時，知道下一站很方便吧？

13
00:01:00,525 --> 00:01:04,700
在電車內會看車內資訊顯示器，

14
00:01:04,700 --> 00:01:12,120
或聽列車廣播、 車內廣播。

15
00:01:14,525 --> 00:01:19,560
但如果這些資訊能顯示在動態島(Dynamic Island)上，會更方便吧？

16
00:01:23,317 --> 00:01:28,260
在發表中，首先會整理演算法所需的資料。

17
00:01:28,260 --> 00:01:34,379
接著實作各個部分，並逐步改善。

18
00:01:37,875 --> 00:01:42,260
演算法需要兩種類型的資料：

19
00:01:43,825 --> 00:01:48,260
路線的靜態資料與即時 GPS 資料。

20
00:01:50,325 --> 00:01:55,280
路線定義為車站的有序列表。

21
00:01:56,819 --> 00:02:03,719
在這個例子中,港未來線由 6 個車站組成。

22
00:02:07,800 --> 00:02:12,140
在路線上,列車雙向運行。

23
00:02:12,139 --> 00:02:23,539
鐵路的實體路線可以用座標點的排列來表示。

24
00:02:26,139 --> 00:02:32,620
這張地圖顯示了這次使用的路線資料。

25
00:02:37,225 --> 00:02:43,460
使用 CoreLocation 從 iPhone 即時取得位置資訊。

26
00:02:43,460 --> 00:02:50,300
該資料儲存在裝置內的 SQLite 中。

27
00:02:52,659 --> 00:02:58,199
位置資訊包含 CLLocation 的所有資訊。

28
00:02:58,199 --> 00:03:04,479
移動、經度、速度、行進方位、精度等。

29
00:03:06,600 --> 00:03:10,260
工作階段（Session）是位置資訊的實驗序列清單

30
00:03:10,259 --> 00:03:14,340
工作階段代表可能的路線

31
00:03:17,620 --> 00:03:23,020
為了將原始資料視覺化，我製作了 macOS App

32
00:03:25,400 --> 00:03:28,600
側邊欄有工作階段的清單

33
00:03:31,200 --> 00:03:37,340
下方面板則有所選工作階段的位置資訊時間序列清單

34
00:03:39,775 --> 00:03:46,060
目的是建立能夠推估這些資訊的演算法

35
00:03:47,175 --> 00:03:51,520
路線、行進方向、下一站

36
00:03:54,375 --> 00:03:57,520
這是系統的整體架構

37
00:03:58,750 --> 00:04:04,925
App會將來自 CoreLocation 的位置資訊依序傳送給演算法

38
00:04:06,900 --> 00:04:11,550
演算法會計算出新的結果

39
00:04:12,250 --> 00:04:18,440
這個結果會用來更新App的使用者介面和即時動態 (Live Activity)。

40
00:04:21,300 --> 00:04:24,960
首先，讓我們只關注一個定位點。

41
00:04:24,959 --> 00:04:28,879
假設我們正在搭乘東橫線，

42
00:04:28,880 --> 00:04:34,100
在綱島站附近記錄了這個定位點。

43
00:04:35,700 --> 00:04:40,350
光憑這一個定位點就能推測出路線嗎?

44
00:04:42,530 --> 00:04:46,000
我們有鐵路的座標點清單。

45
00:04:50,225 --> 00:04:56,520
針對每條路線,找出與這個定位點最接近的鐵路座標,

46
00:04:56,520 --> 00:04:59,983
然後按照距離排序。

47
00:05:02,150 --> 00:05:04,250
結果如下。

48
00:05:06,900 --> 00:05:13,640
最接近的是東橫線的座標,距離約 12 公尺。

49
00:05:16,025 --> 00:05:17,675
完成了

50
00:05:19,350 --> 00:05:21,775
謝謝大家

51
00:05:22,775 --> 00:05:29,880
不過讓我們來看看東橫線的另一個位置點

52
00:05:31,925 --> 00:05:39,040
在這個區域,東橫線與目黑線的軌道是平行的

53
00:05:40,075 --> 00:05:46,440
僅憑這一個位置點,無法特定是哪條路線

54
00:05:49,125 --> 00:05:53,800
演算法會使用路線上的所有位置點來進行推估

55
00:05:54,519 --> 00:06:01,579
在這個例子中,沿著東橫線的空間比目黑線更長。

56
00:06:06,025 --> 00:06:13,720
首先,將這個位置點與最近的軌道座標之間的距離轉換為分數。

57
00:06:13,720 --> 00:06:22,339
越近分數越高,越遠則呈指數下降。

58
00:06:23,819 --> 00:06:28,480
然後將這些分數在時間方向上累加起來

59
00:06:32,425 --> 00:06:38,860
東橫線的累積分數比目黑線還要高

60
00:06:38,860 --> 00:06:41,759
完成了

61
00:06:45,850 --> 00:06:54,440
不過讓我們來看第三個定位點

62
00:06:56,375 --> 00:07:03,600
這是在東京東側幹線京濱東北線的車內記錄的

63
00:07:07,575 --> 00:07:12,360
東海道線與京濱東北線平行運行

64
00:07:14,975 --> 00:07:19,440
但是東海道線會通過許多車站

65
00:07:23,450 --> 00:07:28,560
如果只比較距離分數的話,分數會相同

66
00:07:32,560 --> 00:07:42,480
通過車站時就稍微扣分吧。在站與站之間停車時也稍微扣分。

67
00:07:46,425 --> 00:07:51,050
京濱東北線的分數稍微高一些。

68
00:07:53,379 --> 00:08:03,240
為了確認懲罰的影響,讓我們來看兩個路線的例子。

69
00:08:04,650 --> 00:08:07,740
首先，案例一，從東京站出發。

70
00:08:10,100 --> 00:08:14,620
電車停靠在京濱東北線的第二站。

71
00:08:16,720 --> 00:08:26,060
東海道線這邊因為是在站與站之間停車，所以分數會被扣分。

72
00:08:28,000 --> 00:08:35,039
接下來，東海道線這邊的懲罰會不斷累積。

73
00:08:35,039 --> 00:08:39,440
演算法判斷為京濱東北線。

74
00:08:41,025 --> 00:08:41,840
案例二。

75
00:08:46,720 --> 00:08:51,500
電車通過京濱東北線的第二站。

76
00:08:53,317 --> 00:08:58,000
所以京濱東北線這邊的分數會被扣分。

77
00:08:58,000 --> 00:08:59,960
接下來。

78
00:09:01,100 --> 00:09:04,460
京濱東北線這邊的懲罰會不斷累積。

79
00:09:04,460 --> 00:09:07,559
東海道線と判斷

80
00:09:09,983 --> 00:09:11,800
完成了

81
00:09:15,625 --> 00:09:18,820
還有很多這樣的案例

82
00:09:20,230 --> 00:09:22,475
先繼續往下進行吧

83
00:09:23,900 --> 00:09:30,250
針對兩個方向的路線，推估列車的行進方向

84
00:09:31,400 --> 00:09:34,983
每條路線都有兩個方向

85
00:09:37,000 --> 00:09:42,975
車站的發車資訊會分成上行和下行，對吧

86
00:09:45,800 --> 00:09:49,900
在東橫線，往澀谷方向是上行

87
00:09:49,900 --> 00:09:53,425
往橫濱方向是下行

88
00:09:56,125 --> 00:10:01,975
讓我們來看看在東橫線往澀谷方向記錄的位置資訊

89
00:10:05,559 --> 00:10:12,200
在停靠兩站的時間點，比較停靠的時間序列

90
00:10:12,200 --> 00:10:22,480
如果與資料庫中的車站排列順序一致，就判定行進方向為遞增（Ascending）

91
00:10:24,983 --> 00:10:30,120
先停靠菊名站，之後停靠大倉山站

92
00:10:37,100 --> 00:10:40,720
也就是往澀谷方向

93
00:10:42,150 --> 00:10:43,925
完成了

94
00:10:47,075 --> 00:10:48,475
不過

95
00:10:49,983 --> 00:10:55,280
判定有時候需要花費約五分鐘呢

96
00:10:56,775 --> 00:10:59,920
那麼應該可以做得更好吧

97
00:11:01,725 --> 00:11:06,200
讓我們也使用位置的行進方位

98
00:11:08,625 --> 00:11:14,160
CoreLocation 會以度數回傳 iPhone 的行進方位

99
00:11:16,925 --> 00:11:21,580
0 度是北方，180 度是南方。

100
00:11:23,100 --> 00:11:28,159
要注意的是，我們並沒有使用指南針的方位。

101
00:11:28,159 --> 00:11:38,600
範例位置的行進方位是 359.6 度。

102
00:11:38,600 --> 00:11:41,000
幾乎是朝北的。

103
00:11:41,000 --> 00:11:47,480
首先從這個位置找出最近的兩個車站。

104
00:11:52,775 --> 00:11:56,650
接著配合資料庫的升序 (Ascending)，

105
00:11:56,700 --> 00:12:00,940
計算出兩站之間的方向向量。

106
00:12:01,950 --> 00:12:06,900
在東橫線中，升序的方向是下行。

107
00:12:09,000 --> 00:12:14,700
所以向量是從綱島到大倉山的方向。

108
00:12:18,350 --> 00:12:20,700
還記得內積嗎?

109
00:12:23,320 --> 00:12:28,639
單純用內積就能比較向量的方向

110
00:12:29,983 --> 00:12:33,840
同方向為正,反方向為負

111
00:12:37,525 --> 00:12:39,880
接下來計算內積

112
00:12:47,750 --> 00:12:52,420
如果內積為正,行進方向就是遞增(Ascending)

113
00:12:52,419 --> 00:12:55,399
如果為負,就是遞減(Descending)

114
00:12:57,375 --> 00:13:02,299
計算出的內積是負 0.95

115
00:13:02,299 --> 00:13:03,820
是負值

116
00:13:03,820 --> 00:13:06,179
負值判定為遞減

117
00:13:07,200 --> 00:13:14,399
在資料庫中,遞減對應到東橫線的上行

118
00:13:14,399 --> 00:13:17,980
所以是往澀谷方向前進

119
00:13:20,400 --> 00:13:22,625
完成了

120
00:13:24,750 --> 00:13:28,283
進入演算法的最後一個部分吧

121
00:13:29,950 --> 00:13:34,520
終於可以推估目前的車站了

122
00:13:34,519 --> 00:13:41,159
車內的資訊顯示器會顯示下一站對吧

123
00:13:43,625 --> 00:13:52,080
每個車站會依序切換「下一站」、「即將到站」、「現在停靠」這些階段

124
00:13:56,600 --> 00:14:03,000
在地圖上,各階段會顯示在這個位置

125
00:14:06,325 --> 00:14:12,680
計算從定位點到最近車站的距離與方向向量

126
00:14:14,350 --> 00:14:15,780
下一站的示意圖

127
00:14:15,779 --> 00:14:19,179
即將到站、現在停靠

128
00:14:19,179 --> 00:14:22,580
這也是下一站的示意圖

129
00:14:22,580 --> 00:14:26,600
前一站不在行進方向側，

130
00:14:27,525 --> 00:14:32,940
所以顯示的車站不是前一站，

131
00:14:32,940 --> 00:14:35,639
而是蒲田站。

132
00:14:38,000 --> 00:14:39,820
不對，沒關係。

133
00:14:42,100 --> 00:14:45,180
雖然完成了，

134
00:14:45,179 --> 00:14:49,320
但只靠 GPS 會不穩定。

135
00:14:51,617 --> 00:14:53,900
這次也使用歷史紀錄吧。

136
00:14:55,250 --> 00:15:02,760
針對每個車站，根據與車站的距離和行進方向來分類位置資訊。

137
00:15:05,925 --> 00:15:11,460
圖中顯示的是接近中 (Approaching)、停靠中 (Visiting)、首次離站 (First Departure) 的位置資訊。

138
00:15:14,225 --> 00:15:18,040
焦點車站階段 (Focus Station Phase) 的演算法分為三個步驟。

139
00:15:19,525 --> 00:15:26,259
步驟 1：如果位置在車站範圍內，就分類為「正在停靠」或「接近中」。

140
00:15:29,375 --> 00:15:36,440
如果位置在車站範圍外，就將該位置設定為「首次離站位置」。

141
00:15:38,225 --> 00:15:41,800
步驟 2：使用車站的歷史記錄

142
00:15:41,799 --> 00:15:44,240
來判定車站階段。

143
00:15:47,275 --> 00:15:52,820
這是北千住站「接近中」的車站階段。

144
00:15:54,850 --> 00:15:56,880
「正在停靠」階段。

145
00:15:56,879 --> 00:15:59,860
「已停靠」階段。

146
00:16:02,919 --> 00:16:10,639
步驟 3：在車站的階段歷史記錄中搜尋，以判定焦點階段。

147
00:16:13,275 --> 00:16:24,580
例如，川崎站的最新階段是「已停靠」，那麼焦點階段就是「下一站：蒲田」。

148
00:16:26,940 --> 00:16:30,980
例如，武藏小杉站的最新階段是

149
00:16:30,980 --> 00:16:35,539
已拜訪，元住吉站正在接近的話

150
00:16:37,175 --> 00:16:40,580
焦點階段就是即將抵達元住吉

151
00:16:42,900 --> 00:16:47,480
使用狀態機(State Machine)的話，結果會更加穩定

152
00:16:49,000 --> 00:16:50,975
完成了

153
00:16:52,250 --> 00:16:53,940
最後的完成了

154
00:16:55,940 --> 00:16:59,840
最後來展示開發的 macOS App

155
00:17:02,000 --> 00:17:08,040
我們來看京濱東北線從關內到川崎的乘車過程

156
00:17:09,800 --> 00:17:16,539
演算法處理所有位置資訊需要一點時間

157
00:17:16,539 --> 00:17:20,839
可以用 10 倍速播放

158
00:17:30,275 --> 00:17:34,580
在檢查器(Inspector)中可以看到演算法的結果

159
00:17:34,579 --> 00:17:39,079
京濱東北線的分數最高。

160
00:17:42,100 --> 00:17:47,200
行進方向是大宮方面北行。

161
00:17:49,500 --> 00:17:52,960
也可以看到各站的最新階段。

162
00:17:57,775 --> 00:18:03,339
選擇最後的位置資訊,就能看到整體的車站階段歷程。

163
00:18:03,339 --> 00:18:12,079
點擊車站的階段,就能看到車站階段歷程。

164
00:18:12,079 --> 00:18:19,940
選擇車站,地圖上就會顯示分類後的位置資訊。

165
00:18:24,325 --> 00:18:28,440
為了取得資料,我製作了五個App。

166
00:18:28,440 --> 00:18:33,359
已在 GitHub 上以開源形式公開。

167
00:18:34,875 --> 00:18:38,200
macOS App和演算法都有。

168
00:18:46,750 --> 00:18:51,040
請試用看看駅 Live 這個App。

169
00:18:51,039 --> 00:19:00,819
App會在背景自動啟動，並在動態島（Dynamic Island）上顯示路線與下一站。

170
00:19:05,525 --> 00:19:07,460
今天早上我也用了這個App。

171
00:19:07,460 --> 00:19:10,839
這個App真不錯。

172
00:19:14,125 --> 00:19:16,000
我正在找工作，

173
00:19:16,000 --> 00:19:20,380
如果有想一起工作的人，請務必聯絡我。

174
00:19:21,425 --> 00:19:23,500
我的報告到此結束。謝謝大家。

175
00:19:29,300 --> 00:19:31,025
好的，謝謝 Chris。

176
00:19:31,030 --> 00:19:33,260
那麼接下來我們要進入問答環節。

177
00:19:33,259 --> 00:19:36,039
有問題或意見的人請舉手。

178
00:19:40,059 --> 00:19:41,039
那麼下一位。

179
00:19:44,050 --> 00:19:45,040
感謝您的發表

180
00:19:47,950 --> 00:19:50,360
您大概搭了幾次電車呢？

181
00:19:54,200 --> 00:19:56,200
搭了幾次電車呢？

182
00:19:57,000 --> 00:19:57,440
幾次？

183
00:19:57,440 --> 00:20:05,259
為了製作和驗證這個App，您搭了多少次電車呢？

184
00:20:07,775 --> 00:20:10,820
兩個月？

185
00:20:12,550 --> 00:20:15,140
持續了兩個月、三個月

186
00:20:15,140 --> 00:20:16,039
每天嗎？

187
00:20:16,039 --> 00:20:17,680
不是每天

188
00:20:17,680 --> 00:20:20,140
差不多每天

189
00:20:20,140 --> 00:20:22,940
100 回以上是搭乘過的

190
00:20:22,940 --> 00:20:23,900
謝謝您

191
00:20:24,950 --> 00:20:26,700
那麼，下一位

192
00:20:26,700 --> 00:20:30,160
第三排後面的那位

193
00:20:37,850 --> 00:20:45,640
如果有什麼想要改進的地方，希望能請教一下

194
00:20:45,640 --> 00:20:52,640
如果有還不完善的部分，希望能請教一下

195
00:20:56,125 --> 00:20:57,800
有點困難

196
00:20:59,500 --> 00:21:01,480
用 Ask the Speaker 可以嗎

197
00:21:01,480 --> 00:21:03,740
OK 的

198
00:21:03,740 --> 00:21:04,940
不好意思

199
00:21:05,875 --> 00:21:07,525
謝謝

200
00:21:07,530 --> 00:21:11,080
還有其他人嗎

201
00:21:14,650 --> 00:21:15,560
好的

202
00:21:15,559 --> 00:21:17,339
那麼下一位

203
00:21:19,150 --> 00:21:21,320
感謝您的發表

204
00:21:21,319 --> 00:21:25,299
在東京的車站當中,最困難的

205
00:21:25,299 --> 00:21:28,079
有沒有判定起來比較困難的車站呢

206
00:21:30,075 --> 00:21:32,500
再說一次,最困難的

207
00:21:32,500 --> 00:21:38,740
最難判別下一站的車站是哪一個呢

208
00:21:38,740 --> 00:21:39,220
路線之類的

209
00:21:41,125 --> 00:21:44,080
最難的路線

210
00:21:44,079 --> 00:21:48,680
很多路線行經的車站之類的地方有嗎？

211
00:21:58,775 --> 00:22:02,500
依路線而異，有些比較困難

212
00:22:02,500 --> 00:22:10,099
當路線從地下到地上時

213
00:22:10,099 --> 00:22:18,880
GPS 的精度會改變，所以就很困難

214
00:22:18,880 --> 00:22:22,859
GPS 的精度

215
00:22:22,859 --> 00:22:26,559
川崎站也是

216
00:22:26,559 --> 00:22:30,359
大車站有很多天花板

217
00:22:30,359 --> 00:22:33,259
GPS 會變差

218
00:22:33,259 --> 00:22:35,279
很快就會變差

219
00:22:35,279 --> 00:22:38,259
謝謝

220
00:22:38,259 --> 00:22:43,500
那麼接下來的問題將是最後一個

221
00:22:46,617 --> 00:22:48,900
感謝您的發表

222
00:22:48,900 --> 00:22:54,880
在追蹤車站的過程中，我覺得電池消耗似乎會很大

223
00:22:54,880 --> 00:22:59,859
如果有為了降低電池消耗而做的工夫，可以請您分享嗎

224
00:22:59,859 --> 00:23:01,920
電池的影響

225
00:23:06,750 --> 00:23:08,400
使用的時候

226
00:23:08,400 --> 00:23:14,140
如果使用音樂 app 的話

227
00:23:14,140 --> 00:23:17,140
類似的電池影響

228
00:23:17,140 --> 00:23:24,700
例如一天之後

229
00:23:24,700 --> 00:23:27,240
確認百分比

230
00:23:27,240 --> 00:23:29,839
所有App的百分比

231
00:23:29,839 --> 00:23:32,240
確認之後

232
00:23:32,240 --> 00:23:33,779
大約 7%

233
00:23:33,779 --> 00:23:38,140
搭電車的時候

234
00:23:38,140 --> 00:23:40,380
聽音樂

235
00:23:40,380 --> 00:23:41,900
駅ライブ App

236
00:23:41,900 --> 00:23:45,099
在背景中使用

237
00:23:45,099 --> 00:23:46,700
差不多一樣

238
00:23:46,700 --> 00:23:50,940
但希望能逐漸改善

239
00:23:50,940 --> 00:23:55,839
意思是跟音樂App差不多是嗎

240
00:23:55,839 --> 00:23:56,880
謝謝

241
00:23:58,075 --> 00:23:58,800
謝謝

242
00:23:58,800 --> 00:24:03,250
那麼接下來是最後一個問題,剛才舉手的那位……

243
00:24:04,799 --> 00:24:07,799
啊,在那邊。

244
00:24:09,325 --> 00:24:11,800
我用英文提問。

245
00:24:11,799 --> 00:24:16,799
您今天展示的演算法真的很棒。

246
00:24:16,800 --> 00:24:22,675
這個演算法是否類似於……我的意思是……

247
00:24:24,550 --> 00:24:35,800
類似於我們在 Apple Maps 中使用的 Google Maps 來追蹤列車。這個演算法是否遵循與這些App相同的模式？

248
00:24:35,800 --> 00:24:42,825
我不太確定。他們可能使用更進階的技術，因為我認為他們是在伺服器端運行的。

249
00:24:42,830 --> 00:24:48,800
有一種叫做航位推算（dead reckoning）的技術，我沒有機會深入探討。

250
00:24:48,799 --> 00:24:57,799
這意味著你會根據過去的 GPS 位置，持續預測下一個 GPS 點。

251
00:24:57,800 --> 00:25:04,350
當精度降低時，你就持續預測下一個點，這涉及很多數學運算。

252
00:25:04,350 --> 00:25:08,200
我還沒有做到這一點。目前還是相當簡單。

253
00:25:08,200 --> 00:25:13,200
我發現逐步修補問題比較容易。

254
00:25:13,200 --> 00:25:19,400
並找出困難點在哪裡，直到我們必須重新改寫為止。

255
00:25:19,400 --> 00:25:24,599
Google 地圖在沒有 GPS 訊號的時候，對吧？

256
00:25:24,599 --> 00:25:30,200
它仍然會預測你目前所在的下一個位置。

257
00:25:30,200 --> 00:25:33,400
你知道那是怎麼運作的嗎？

258
00:25:33,400 --> 00:25:43,900
我不太確定是哪個功能，像是當你規劃了一趟行程，當你有行程的時候，是這樣嗎？

259
00:25:43,900 --> 00:25:51,339
喔不是，當你要規劃的時候，就像是當你在隧道裡面的時候，所以

260
00:25:51,339 --> 00:25:56,799
沒有 GPS 訊號，但它仍然知道你目前的位置以及你的下一個目的地

261
00:25:56,799 --> 00:26:00,799
你知道那是怎麼運作的嗎？

262
00:26:00,799 --> 00:26:04,799
我想就是我剛才提到的航位推算 (dead reckoning)

263
00:26:04,800 --> 00:26:09,800
他們就是持續預測……

264
00:26:09,800 --> 00:26:16,800
裝置只能取得一定數量的資料，所以他們必須利用已經擁有的資料來做些什麼

265
00:26:16,799 --> 00:26:18,799
謝謝

266
00:26:18,799 --> 00:26:20,799
是的，謝謝

267
00:26:20,799 --> 00:26:24,799
那麼，時間到了，Q&A 環節就到此結束

268
00:26:24,799 --> 00:26:27,220
接下來是一分鐘的意見回饋時間

269
00:26:27,220 --> 00:26:29,119
請各位掃描 QR Code

270
00:26:29,119 --> 00:26:30,259
提供您的意見回饋

271
00:26:54,799 --> 00:27:24,779
感謝您的收看

272
00:27:24,799 --> 00:27:37,920
感謝您的收看

