1
00:00:08,000 --> 00:00:13,419
では大規模アプリにおけるXcode Preview ズ実用化までの道のりというタイトルで発表させていただきます

2
00:00:13,419 --> 00:00:14,380
よろしくお願いします

3
00:00:14,380 --> 00:00:16,519 
まず自己紹介です

4
00:00:16,519 --> 00:00:18,559 
池翔 池田翔と言います

5
00:00:18,559 --> 00:00:23,739 
LINEヤフー株式會社でLINEアプリのMDXチーム

6
00:00:23,859 --> 00:00:30,760 
開発者體験の改善や開発生產性の改善というのをミッションに仕事をしているチームで

7
00:00:30,760 --> 00:00:36,320 
主にiOSアプリのビルドシステムだったりCI/CDのメンテナンスなどをしています

8
00:00:36,320 --> 00:00:39,280 
GitHubでいろいろ活動していて

9
00:00:40,200 --> 00:00:47,133
Swiftのコミッターの権限を持っていたり、過去にも様々なOSSのメンテナンスをやってきました。

10
00:00:47,133 --> 00:00:52,880
iOSDC の登壇は過去にLTを 5 回しているんですが

11
00:00:52,880 --> 00:00:55,140
レギュラートークは今回が初めてなので

12
00:00:55,140 --> 00:00:57,439
ちょっと緊張していますが

13
00:00:57,439 --> 00:00:59,000
お手柔らかにお願いします

14
00:00:59,000 --> 00:01:02,119
ということでLINEアプリですね

15
00:01:02,119 --> 00:01:05,980
タイトルの大規模アプリというのはLINEのことになります

16
00:01:05,980 --> 00:01:11,260
では本日のアジェンダはこのようになっていますので

17
00:01:11,260 --> 00:01:13,019
一つずつ見ていきましょう

18
00:01:13,019 --> 00:01:20,040
まず LINE iOS アプリの背景と課題についてお話ししようと思います

19
00:01:20,040 --> 00:01:25,480
LINE iOS アプリの特徴はこのような形になっています

20
00:01:25,480 --> 00:01:29,420
最近は多くのアプリがそうなっているように

21
00:01:29,420 --> 00:01:33,578
マルチモジュール構成で数百のモジュールから成り立っています

22
00:01:33,578 --> 00:01:36,218
そのようにモジュールがたくさんあるので

23
00:01:36,218 --> 00:01:38,159
アプリの軌道を高速化するために

24
00:01:38,159 --> 00:01:40,760
 static frameworkを大規模に活用しています

25
00:01:40,760 --> 00:01:44,500
モジュール化をしているとはいえ

26
00:01:44,500 --> 00:01:48,459
出がしきな部分でモジュール化できていないコードがあったり

27
00:01:48,459 --> 00:01:51,959
あとこれだけの数百のモジュールを束ねる分だけでも

28
00:01:51,959 --> 00:01:55,040
アプリケーションターゲット自体もかなり巨大なので

29
00:01:55,040 --> 00:01:57,799
そのアプリケーションターゲットを直接 Preview するというのは

30
00:01:57,799 --> 00:01:59,680
かなり不向きな構成になっています

31
00:01:59,680 --> 00:02:03,799
現在の開発規模をざっくりとご紹介します

32
00:02:03,799 --> 00:02:06,579
コード行数は 250 万行以上で

33
00:02:06,579 --> 00:02:08,479
Xコード project が 600 以上

34
00:02:08,479 --> 00:02:12,419
ターゲット数はテストターゲットを除いても 800 以上あります

35
00:02:12,419 --> 00:02:14,840
またビルド済みフレームワーク数

36
00:02:14,840 --> 00:02:19,300
これは社内パッケージや外部のライブラリですね

37
00:02:19,300 --> 00:02:22,520
をスキピオという Ginnet さんの　Scipio　で

38
00:02:22,520 --> 00:02:25,139
ビルド済みのXCフレームワークにして使っているものが

39
00:02:25,139 --> 00:02:28,400
150 以上あるというようなかなりの規模になっています

40
00:02:28,400 --> 00:02:32,080
ちょっと繰り返しになりますが

41
00:02:32,080 --> 00:02:34,818
LINE iOSのアプリで非常に多くのモジュールがあるので

42
00:02:34,818 --> 00:02:36,740
これを dynamic link で使ってしまうと

43
00:02:36,740 --> 00:02:39,258
アプリの起動時間がかなり遅くなってしまうので

44
00:02:39,258 --> 00:02:41,699
static framework として使っています

45
00:02:41,699 --> 00:02:47,300
最近のiOSでdyldが進化したり

46
00:02:47,300 --> 00:02:50,258
cache ができたりで早くなっている部分もあると思いますが

47
00:02:50,258 --> 00:02:52,000
まだ static framework を使っています

48
00:02:52,000 --> 00:02:55,378
ただしここで Preview で困ったことがあります

49
00:02:55,378 --> 00:02:59,098
Xcode 15までは dynamic framework でないと

50
00:02:59,098 --> 00:03:01,800
そのモジュールを Preview することができませんでした

51
00:03:01,800 --> 00:03:06,080
これはXcodeが Preview の実行エンジンの

52
00:03:06,080 --> 00:03:07,900
技術的な制限というところですね

53
00:03:07,900 --> 00:03:10,158
なのでLINE iOSアプリでは

54
00:03:10,158 --> 00:03:13,718
事実上 Preview を使うことができない状態になっていました

55
00:03:13,718 --> 00:03:17,960
ここに一つの変化が訪れます

56
00:03:17,960 --> 00:03:21,438
Xcode 15までは今言ったように

57
00:03:21,438 --> 00:03:24,280
dynamic framework でしか Preview が使えませんでしたが

58
00:03:24,280 --> 00:03:26,960
Xcode 16でついに static framework

59
00:03:26,960 --> 00:03:30,280
static library のサポートが追加されたということが分かりました

60
00:03:30,280 --> 00:03:33,098
これがリリースノートに載っているところのハイライトですね

61
00:03:33,098 --> 00:03:36,240
ということで検証を開始します

62
00:03:36,240 --> 00:03:41,000
実際に LINE iOS の workspaceの 中で試すときに

63
00:03:41,000 --> 00:03:44,318
既存のモジュールをいきなり試すのはちょっと大変かなと思ったので

64
00:03:44,318 --> 00:03:48,500
必要最小限の小さいモジュールを試しに作って動かしてみると

65
00:03:48,500 --> 00:03:52,460
static frameworkでもちゃんと Preview が動くことを確認できました

66
00:03:52,460 --> 00:03:54,280
やったー

67
00:03:54,280 --> 00:03:57,460
ということでなんですが一つ注意事件があって

68
00:03:57,460 --> 00:04:00,419
新しい実行エンジンというのを使う必要があります

69
00:04:00,419 --> 00:04:06,378
16から実行エンジン自体が全く新しいものに切り替わっているんですが

70
00:04:06,378 --> 00:04:08,580
古い実行エンジンを使うという設定もあって

71
00:04:08,580 --> 00:04:10,438
これをオフにする必要があります

72
00:04:10,438 --> 00:04:14,399
Editor > Canvas > Uses Legacy Previews Execution  を off にしましょう

73
00:04:14,399 --> 00:04:19,220
次に既存のモデルでちゃんと試してみようとしたんですが

74 
00:04:19,220 --> 00:04:24,860
ここで availability を使うと Preview が crash するということを発見してしまいます

75
00:04:24,860 --> 00:04:30,079
これは実際にLINEアプリのコードベースの中でいうとかなり影響範囲が大きくて

76
00:04:30,079 --> 00:04:33,040
一部潰すだけにはいかなくてですね

77
00:04:33,040 --> 00:04:35,980
問題が直らないとLINEアプリでは実用できないレベルでした

78
00:04:35,980 --> 00:04:39,060
ということでAppleに feedback を出して

79
00:04:39,060 --> 00:04:41,000
修正を待つ日々が始まります

80
00:04:41,000 --> 00:04:44,740
こういったFB 番号タイトルでfeedbackを出しました

81
00:04:44,740 --> 00:04:47,778
どういう内容かというとこのような

82
00:04:47,778 --> 00:04:50,838
If availableでOSバージョンが書いてあって

83
00:04:50,838 --> 00:04:54,379
この時実際の project 側のターゲットの

84
00:04:54,379 --> 00:04:58,319
デプロイメントターゲットがこのバージョンより低いと

85
00:04:58,319 --> 00:05:00,139
Preview の実行エンジンが

86
00:05:00,139 --> 00:05:02,838
その動作環境を判定するための symbol を

87
00:05:02,838 --> 00:05:05,620
見つけられなくてクラッシュするというものでした

88
00:05:05,620 --> 00:05:07,740
これを待っていたら

89
00:05:07,740 --> 00:05:10,879
Xcode 16.3でやっとこのバグが修正されました

90
00:05:10,879 --> 00:05:11,959
やったー

91
00:05:11,959 --> 00:05:13,379
ということで

92
00:05:13,379 --> 00:05:16,180
自分が出したフィードバックが

93
00:05:16,180 --> 00:05:19,699
Xcodeのリリースノートで修正されたということを

94
00:05:19,699 --> 00:05:21,500
知るのは非常に嬉しい体験ですね

95
00:05:21,500 --> 00:05:22,778
ということで

96
00:05:22,778 --> 00:05:26,379
実際にさっきのフィードバックで出していた

97
00:05:26,379 --> 00:05:28,759
Preview のコードがちゃんと動いて

98
00:05:28,759 --> 00:05:29,939
aaaって出てますね

99
00:05:29,939 --> 00:05:31,000
Preview が動いている

100
00:05:31,000 --> 00:05:32,259
やったー

101
00:05:32,259 --> 00:05:35,660
ということでめでたしめでたし

102
00:05:35,660 --> 00:05:39,333
以上でこの発表を終わりません

103
00:05:39,333 --> 00:05:40,665
そんなにうまくいくわけはありません

104
00:05:41,920 --> 00:05:43,399
ということで

105
00:05:43,399 --> 00:05:45,660
ここからは実際に

106
00:05:45,660 --> 00:05:47,300
実用化にこぎつけるまでに

107
00:05:47,300 --> 00:05:48,579
どのような課題が

108
00:05:48,579 --> 00:05:52,100
発見してそれにどのように対処してきたか

109
00:05:52,100 --> 00:05:54,360
ということをお話ししようと思います

110
00:05:54,360 --> 00:05:58,399
ここから主に3つの点についてお話ししていきます

111
00:05:58,399 --> 00:06:02,660
ビルドスキームの管理と Preview 対象からの依存関係の削減と

112
00:06:02,660 --> 00:06:06,278
画像やローカリゼーションなどのリソースの読み込みについてです

113
00:06:06,278 --> 00:06:09,699
1つ目はビルドスキーム管理です

114
00:06:09,699 --> 00:06:14,600
Xcode Preview で特定のコンポーネント

115
00:06:14,600 --> 00:06:18,740
それが入っているターゲットモジュールを Preview するとなると

116
00:06:18,740 --> 00:06:20,459
Xcode のビルドスキーム

117
00:06:20,459 --> 00:06:24,300
一番上の実行ボタンの隣に出ているところですね

118
00:06:24,300 --> 00:06:27,420
ここからどのターゲットスキームをビルドするかというのを選んで

119
00:06:27,420 --> 00:06:29,720
それで Preview を実行するわけですが

120
00:06:29,720 --> 00:06:32,540
そういうふうにそれ用のスキームが必要になります

121
00:06:32,540 --> 00:06:37,920
こういうものをやりたければこのコンポーネント実装が入っているターゲットを選ぼうということですね

122
00:06:37,920 --> 00:06:43,338
なんですがLINE iOSの project はモジュールが数百個あるので

123
00:06:43,338 --> 00:06:46,519
すぐ別のターゲットに一つ一つビルドスキームを作ると

124
00:06:46,519 --> 00:06:49,800
リストが後ろみたいにめっちゃ溢れてしまって

125
00:06:49,800 --> 00:06:51,740
大変なので非現実的です

126
00:06:51,740 --> 00:06:53,459
使い物にならなくなってしまいます

127
00:06:53,459 --> 00:06:57,300
もしUIが入っているようなUIモジュールというものに

128
00:06:57,300 --> 00:06:59,600
絞ったとしてもまだまだ数が多いです

129
00:06:59,600 --> 00:07:03,740
さらにアプリの機能開発というのが

130
00:07:03,740 --> 00:07:07,060
結構モジュールごとに担当チームが分かれていて

131
00:07:07,060 --> 00:07:10,560
自分たちのチームに関係のないものが

132
00:07:10,560 --> 00:07:13,079
リストに出ていてもノイズになってしまいます

133
00:07:13,079 --> 00:07:16,220
なのでここの実用としては

134
00:07:16,220 --> 00:07:19,040
自分たちに必要なビルドスキームだけを

135
00:07:19,040 --> 00:07:22,240
作成表示できるような仕組みが必要だと考えました

136
00:07:22,240 --> 00:07:26,800
そこでXcodeGENのスキームを作るための仕組みの中の

137
00:07:26,800 --> 00:07:30,660
Scheme ManagementのSharedとIsShownという設定を使うことにしました

138
00:07:30,660 --> 00:07:32,480
ここではですね

139
00:07:32,480 --> 00:07:35,819
600個といったXcode project とかは

140
00:07:35,819 --> 00:07:39,838
我々はXcodeGENというYAMLからXcode project を作る仕組みを使って

141
00:07:39,838 --> 00:07:40,660
制御しているんですが

142
00:07:40,660 --> 00:07:43,540
この中でのスキーム生成の設定を使っています

143
00:07:43,540 --> 00:07:47,160
Shared なスキームとして作って

144
00:07:47,160 --> 00:07:49,639
スキームの存在体をチームで共有しつつ

145
00:07:49,639 --> 00:07:51,720
IsShown という設定をしておくと

146
00:07:51,720 --> 00:07:54,100
default では非表示にしておいて

147
00:07:54,100 --> 00:07:58,800
使いたい人だけが手元で表示を on にするというような制御ができるようになります

148
00:07:58,800 --> 00:08:03,060
この表示非表示の状態っていうのは user 単位で管理されるものになっていて

149
00:08:03,060 --> 00:08:05,879
Xcode project の中の xcuserdata っていう

150
00:08:05,879 --> 00:08:10,199
user 単位のディレクトリの中の設定ファイルに保存されます

151
00:08:10,199 --> 00:08:14,240
こういうスキームマネジメントの画面で

152
00:08:14,240 --> 00:08:16,620
シェアードでチェックが入った状態で作られていて

153
00:08:16,620 --> 00:08:22,079
最初は左側のショーのチェックボックスがオフなんですが

154
00:08:22,079 --> 00:08:27,060
これを手元でオンにしてクローズして使いましょうという形ですね

155
00:08:27,060 --> 00:08:32,418
この設定を行うためのテンプレートっていうのをXcodeジェンガーでも用意して

156
00:08:32,418 --> 00:08:36,019
この一つ一つ左側の設定を書くんじゃなくて

157
00:08:36,019 --> 00:08:40,200
テンプレートにこれを書けば使えるようにするという形にしました

158
00:08:40,200 --> 00:08:44,298
二つ目は Preview 対象から依存環境を減らすという話です

159
00:08:44,298 --> 00:08:50,178
LINEのマルチモジュール構成はざっくりこのような構成になっていまして

160
00:08:50,178 --> 00:08:58,379
Feature Shared Utilityというレイヤーとその下に外部ライブラリー 社内パッケージみたいな形になっていて

161
00:08:58,379 --> 00:09:03,440
上位のレイヤーは下位のレイヤーに依存しておりが 下位のレイヤーは上位に依存してはいけない

162
00:09:03,440 --> 00:09:08,940
また各レイヤーの中でUIモジュールとロジックモジュールという分離があるんですが

163
00:09:08,940 --> 00:09:11,120
UIからLogicに依存していが

164
00:09:11,120 --> 00:09:14,480
LogicはUIに依存してはいけないという感じになっています

165
00:09:14,480 --> 00:09:19,500
ここでUIがLogicモジュールに依存する構成なんですが

166
00:09:19,500 --> 00:09:22,678
当然 Preview したいUIコンポーネントというのは

167
00:09:22,678 --> 00:09:25,178
UIモジュールの中に入っていますよね

168
00:09:25,178 --> 00:09:26,379
なんですが

169
00:09:26,379 --> 00:09:29,320
UIモジュールを Preview したいから

170
00:09:29,320 --> 00:09:32,240
UIモジュールのスキームを選択してビルドが走る

171
00:09:32,240 --> 00:09:35,700
そうするとLogicモジュールとその依存も

172
00:09:35,700 --> 00:09:37,538
当然一緒にビルドしなければなりません

173
00:09:37,538 --> 00:09:40,980
この時ロジックモジュールがたくさんの依存を持っていると

174
00:09:40,980 --> 00:09:43,139
ただUIを Preview したいだけなのに

175
00:09:43,139 --> 00:09:46,480
たくさんのロジックの依存をビルドしないといけないという形で

176
00:09:46,480 --> 00:09:48,519
結構ビルド時間が長くなってしまったり

177
00:09:48,519 --> 00:09:54,340
ひどい時にはXコード側が正しくビルドや Preview が動かなくなって

178
00:09:54,340 --> 00:09:59,019
 Preview のキャンバスの画面でずっとローディングの状態が続いて

179
00:09:59,019 --> 00:10:03,220
何のエラーも吐かないし Preview も表示されないという状態になってしまいます

180
00:10:03,220 --> 00:10:06,340
これをどう解決するかというところで

181
00:10:06,340 --> 00:10:08,379
少しUIモジュールの足として

182
00:10:08,379 --> 00:10:12,360
Previable UIモジュールというものを定義することを

183
00:10:12,360 --> 00:10:15,778
提案をしてガイドラインに書いたりしています

184
00:10:15,778 --> 00:10:20,259
このモジュールはロジックモジュールに依存しないという形にしています

185
00:10:20,259 --> 00:10:21,940
してはいけないという形です

186
00:10:21,940 --> 00:10:25,899
実際にボタンを押したときのアクションとかはどうするのか

187
00:10:25,899 --> 00:10:27,480
というところに関しては

188
00:10:27,480 --> 00:10:31,158
この上位のUIモジュールがロジックと

189
00:10:31,158 --> 00:10:34,100
ロジックを持たないPreviable UI 両方に依存して

190
00:10:34,100 --> 00:10:38,658
そこからクロージャーだったりバインディングでロジックを注入するという形ですね

191
00:10:38,658 --> 00:10:44,278
こっちはこういう名前で Preview できるような状態にしておこう

192
00:10:44,278 --> 00:10:49,960
 Preview したいコンポーネントはこっちに実装しましょうという形で定義をしています

193
00:10:49,960 --> 00:10:53,259
こういう形で依存性を分離したり軽量化をして

194
00:10:53,259 --> 00:10:59,178
新規のモジュールだったりとか既存の依存が多いモジュールで Preview したいときは

195
00:10:59,178 --> 00:11:01,798
こういう風に分離していきましょうという話をしています

196
00:11:01,798 --> 00:11:05,080
じゃあ3つ目最後ですね

197
00:11:05,080 --> 00:11:09,120
画像やローカリゼーションなどのリソースの読み込みの話です

198
00:11:09,120 --> 00:11:11,678
結構ここが難しいポイントですね

199
00:11:11,678 --> 00:11:19,278
LINEアプリは過去の歴史もあってだと思うんですが

200
00:11:19,278 --> 00:11:23,820
アプリ全体的にだったり複数の機能で共通して使うような

201
00:11:23,820 --> 00:11:27,120
画像やローカリゼーションの文字列というものを

202
00:11:27,120 --> 00:11:30,918
LINEアプリの一番上のアプリケーションターゲット本体に

203
00:11:30,918 --> 00:11:33,399
埋め込むような形になっています

204
00:11:33,399 --> 00:11:36,139
分離された各モジュールっていうのは

205
00:11:36,139 --> 00:11:38,840
その共通系のリソースを扱いたいときには

206
00:11:38,840 --> 00:11:40,778
 Bundle.main を通じて

207
00:11:40,778 --> 00:11:43,080
アプリ側に埋め込まれているであろうものに

208
00:11:43,080 --> 00:11:44,720
アクセスするって形になっています

209
00:11:44,720 --> 00:11:47,580
普段はこれで問題ないですね

210
00:11:47,580 --> 00:11:52,860
ただし直接的に文字列とかでアクセスするのは大変ですし

211
00:11:52,860 --> 00:11:53,960
type 安全ではないので

212
00:11:53,960 --> 00:11:56,918
コード生成したアクセサーコードっていうのが

213
00:11:56,918 --> 00:11:58,658
共通モジュールとして定義されて

214
00:11:58,658 --> 00:12:01,019
それを使ってアクセスするようになっています

215
00:12:01,019 --> 00:12:04,440
これ Preview の時に困るんですね

216
00:12:04,440 --> 00:12:09,158
 Preview の時はこの Bundle.main のアクセスがうまくいきません

217
00:12:09,158 --> 00:12:13,399
なぜかというとXcode Preview の実行環境っていうのは

218
00:12:13,399 --> 00:12:20,100
XCpreviewAgent.appっていうXcode 側が用意しているアプリがホストになっていて

219
00:12:20,100 --> 00:12:26,840
そのアプリが Preview 対象のモジュールをロードして表示するっていう形になっているんですね

220
00:12:26,840 --> 00:12:31,178
この時そのモジュール側からは Bundle.main にアクセスすると

221
00:12:31,178 --> 00:12:35,440
その Bundle.main はこの XCPreviewAgent.app を指してしまうんですね

222
00:12:35,440 --> 00:12:38,740
当然このXcode 側が用意しているアプリに

223
00:12:38,740 --> 00:12:42,019
我々のLINEアプリ用のリソースというのは埋め込まれていないので

224
00:12:42,019 --> 00:12:45,178
 Bundle.main でアクセスしてもリソースが見つからなくて

225
00:12:45,178 --> 00:12:49,298
当然フォースロードがしているとクラッシュしてしまいます

226
00:12:49,298 --> 00:12:56,658
ここでの解決策として我々はディベロップメントアセットというものを使うことにしました

227
00:12:56,658 --> 00:13:01,440
これを使ってアクセサーコードの用の共通モジュールに

228
00:13:01,440 --> 00:13:04,899
一時的にアプリの代わりにこっちにリソースを埋め込むということにしました

229
00:13:04,899 --> 00:13:09,220
Development Assetsというのは Preview 用の画像リソースや

230
00:13:09,220 --> 00:13:14,418
Mockデータなどの製品版のアプリには含めないアセットやソースコードのパスを指定するという機能で

231
00:13:14,418 --> 00:13:16,100
これはアーカイブビルド

232
00:13:16,100 --> 00:13:19,399
Xコードビルドのアーカイブコマンドのアクションの時には

233
00:13:19,399 --> 00:13:21,700
ビルド対象から除外されるようになっています

234
00:13:21,700 --> 00:13:24,759
これはSwiftのソースコードもいけるしリソースもいけるし

235
00:13:24,759 --> 00:13:26,558
どちらも使えます

236
00:13:26,558 --> 00:13:31,840
Xコードの設定的にはこういったターゲットの設定のジェネラルの中に

237
00:13:31,840 --> 00:13:34,178
一番下にDevelopment Assetsという欄があって

238
00:13:34,178 --> 00:13:36,558
ここにパスを追加していくようになっていますし

239
00:13:36,558 --> 00:13:40,980
ビルド設定でいうとDevelopment Assets Passesという設定があります

240
00:13:40,980 --> 00:13:45,759
これを使ってこのShared UI Common Media Assetsという

241
00:13:45,759 --> 00:13:49,080
シェアードのアクセサーコードを定義しているモジュールの中に

242
00:13:49,080 --> 00:13:52,940
MediaX Assets 普段はアプリ本体に埋め込んでいるものを

243
00:13:52,940 --> 00:13:55,940
 Preview の時だけここに埋め込むということをしました

244
00:13:55,940 --> 00:14:02,019
さらに普段 Bundle.main を使ってアクセスしている部分のバンドルの向き先を

245
00:14:02,019 --> 00:14:05,158
この自分のモジュールの中に

246
00:14:05,158 --> 00:14:10,580
自分のアクセサーコードのところのモジュールに差し替えるということをしています

247
00:14:10,580 --> 00:14:15,899
こうすることで Preview の時でもアクセスしたいリソースを正しく見つけられるようになりました

248
00:14:15,899 --> 00:14:22,379
これがバンドルの向き先を変えるコードのイメージですね

249
00:14:22,379 --> 00:14:25,700
まず Preview は基本デバッグでビルドになるので

250
00:14:25,700 --> 00:14:27,759
デバッグの時だけに絞り

251
00:14:27,759 --> 00:14:31,220
さらに Preview の実行時にはですね

252
00:14:31,220 --> 00:14:35,918
Xcode running for previewsという環境変数が定義されているので

253
00:14:35,918 --> 00:14:38,759
これで Preview で動いているかどうかというのが判断できます

254
00:14:38,759 --> 00:14:42,278
この時にちょっとトリッキーなんですが

255
00:14:42,278 --> 00:14:45,940
バンドル4クラスを使って得たパスに

256
00:14:45,940 --> 00:14:47,399
そこがですね

257
00:14:47,399 --> 00:14:50,798
 Preview の実行環境下だと

258
00:14:50,798 --> 00:14:55,399
このバンドル4クラスがデバッグiPhoneシミュレーターのパスを返すようになっていて

259
00:14:55,399 --> 00:14:56,178
不思議なんですが

260
00:14:56,178 --> 00:14:58,440
その中にはXcodeがビルドした

261
00:14:58,440 --> 00:15:01,480
このシェアドのコモンメディアセッツの

262
00:15:01,480 --> 00:15:03,480
フレームワークがビルドされた状態で

263
00:15:03,480 --> 00:15:04,139
存在しているので

264
00:15:04,139 --> 00:15:06,538
そのフレームワークのパスをバンドルとして使う

265
00:15:06,538 --> 00:15:07,960
というようになります

266
00:15:07,960 --> 00:15:09,980
そうするとこのバンドルの中にある

267
00:15:09,980 --> 00:15:13,340
アセッツにアクセスできるという

268
00:15:13,340 --> 00:15:14,298
寸法ですね

269
00:15:14,298 --> 00:15:18,340
これ基本的には問題なかったんですが

270
00:15:18,340 --> 00:15:19,460
一部のモジュールで

271
00:15:19,460 --> 00:15:21,720
直接このイメージネームドを使っていて

272
00:15:21,720 --> 00:15:23,720
バンドルの指定がちゃんとできていないので

273
00:15:23,720 --> 00:15:27,500
そのままだと Bundle.main にアクセスしてしまうものがあったりしたので

274
00:15:27,500 --> 00:15:29,658
そこをこの下に書いているような

275
00:15:29,658 --> 00:15:32,399
コード生成したアクセサを使うように書いて

276
00:15:32,399 --> 00:15:35,440
そうすることでちゃんとバンドルが差し替わるようになりました

277
00:15:35,440 --> 00:15:39,340
これでだいたいいい感じになったので

278
00:15:39,340 --> 00:15:42,360
現在の状況と今後の展望というのをお話しします

279
00:15:42,360 --> 00:15:48,038
改めて static framework での動作検証がうまくいきました

280
00:15:48,038 --> 00:15:52,600
そして本日紹介したような様々な下準備をすることで

281
00:15:52,600 --> 00:15:54,678
ある程度環境が整備できたので

282
00:15:54,678 --> 00:15:58,259
これを開発者 各開発チームに使ってもらうための

283
00:15:58,259 --> 00:15:59,759
ガイドラインを作成し

284
00:15:59,759 --> 00:16:02,940
それを各開発チームにアナウンスしました

285
00:16:02,940 --> 00:16:07,639
ここからは各開発チームに実際に使ってもらう

286
00:16:07,639 --> 00:16:09,860
導入をしてもらうというフェーズが始まっていて

287
00:16:09,860 --> 00:16:13,379
現時点で先ほど話したプレビュアブルターゲットというのが

288
00:16:13,379 --> 00:16:15,120
5 件ほど定義されていて

289
00:16:15,120 --> 00:16:16,940
アナウンスから3 件ほど増加

290
00:16:16,940 --> 00:16:20,500
ちょっとずつですが導入が始まっています

291
00:16:20,500 --> 00:16:24,740
今後の展望ですが

292
00:16:24,740 --> 00:16:26,798
今お話ししてきたように

293
00:16:26,798 --> 00:16:32,538
Xcode Previews 自体がまだまだ安定していない部分というのも多いので

294
00:16:32,538 --> 00:16:40,158
Apple 側でXcodeへの機能追加や安定性の改善がなされていくということを期待したいと思います

295
00:16:40,158 --> 00:16:45,320
また開発チームで実際にこれを導入していってもらうときに

296
00:16:45,320 --> 00:16:47,240
いろんな疑問や質問が生まれて

297
00:16:47,240 --> 00:16:51,600
場合によってはそのケース考慮が漏れていたねっていうことが

298
00:16:51,600 --> 00:16:53,019
いろいろ見つかってくると思うので

299
00:16:53,019 --> 00:16:55,960
そういった部分をどんどんガイドラインに反映して

300
00:16:55,960 --> 00:16:59,158
漏れがないドキュメントを作っていきたいと思っています

301
00:16:59,158 --> 00:17:03,538
さらに社内勉強会で発表して各チームに伝えたり

302
00:17:03,538 --> 00:17:07,200
ワークショップを実施して実際に一緒にやってみるなどして

303
00:17:07,200 --> 00:17:10,618
採用率を高めていければなというのもありますね

304
00:17:10,618 --> 00:17:15,278
またこれらの施策の効果測定として

305
00:17:15,278 --> 00:17:19,038
ちゃんと活用状況をトラッキングできるようにもしていきたいと考えています

306
00:17:19,038 --> 00:17:21,940
実際に Preview をできるターゲットっていうのが

307
00:17:21,940 --> 00:17:24,098
どれだけ定義されているかっていうところであったり

308
00:17:24,098 --> 00:17:30,338
実際に Preview 自体の数がどれだけ定義されているかっていうところを計測して

309
00:17:30,338 --> 00:17:33,200
その計測のためのツールを作ったり

310
00:17:33,200 --> 00:17:37,798
定期実行してモニタリングしていくってことができるようにしていきたいと考えています

311
00:17:37,798 --> 00:17:41,759
最後にもう一つ大きな玉があるんですが

312
00:17:41,759 --> 00:17:44,318
Mergeable Libraryの検討というものがあります

313
00:17:44,318 --> 00:17:48,338
ここまで見切った問題というのはですね

314
00:17:48,338 --> 00:17:53,240
大体がほとんどが static framework を使っているがゆえの問題でした

315
00:17:53,240 --> 00:17:56,940
そのために依存モジュールが多いとリンクが重くなって

316
00:17:56,940 --> 00:17:59,420
 Preview がちゃんと動かなくなったり

317
00:17:59,420 --> 00:18:04,318
それを避けるためにモジュールを Previewable UI みたいな形で分離したり

318
00:18:04,318 --> 00:18:06,298
ということをしないといけなくなっていました

319
00:18:06,298 --> 00:18:09,798
なんですがマージャブルライブラリというものを導入するとですね

320
00:18:09,798 --> 00:18:11,400
詳細はちょっと省くんですが

321
00:18:11,400 --> 00:18:16,578
デバッグビルドではスタティックじゃなくてダイナミックリンクになるという挙動があるので

322
00:18:16,578 --> 00:18:23,680
そうするとこの Preview をするときのリンクの重さというのが軽減できるんじゃないかなということを考えています

323
00:18:23,680 --> 00:18:26,240
マージャブライブラについて詳しくは

324
00:18:26,240 --> 00:18:30,759
2023 年のiOS DCのGIGINETさんチームメイトなんですが

325
00:18:30,759 --> 00:18:36,160
GIGINETさんの発表マージャブライブラで高速なアプリ起動を実現しようもぜひ参照してください

326
00:18:36,160 --> 00:18:37,980
まとめです

327
00:18:37,980 --> 00:18:42,500
LINE iOSアプリという大規模なアプリの開発に

328
00:18:42,500 --> 00:18:44,838
Xcode Preview を導入し始めました

329
00:18:44,838 --> 00:18:48,980
どのような課題があるのかを丁寧に洗い出して

330
00:18:48,980 --> 00:18:51,000
それらを一つ一つ調査解決し

331
00:18:51,000 --> 00:18:53,880
Xcodeにもフィードバックしてバグを修正してもらいました

332
00:18:53,880 --> 00:18:57,358
static framework でXcode Preview を活用するには

333
00:18:57,358 --> 00:18:58,900
まだまだハードルがいろいろあります

334
00:18:58,900 --> 00:19:00,980
 Preview 自体の動作安定性で

335
00:19:00,980 --> 00:19:03,460
これは私のエンジンがじっとコンパイル

336
00:19:03,460 --> 00:19:06,618
じっとでリンクしているとかっていうところは結構肝で

337
00:19:06,618 --> 00:19:08,420
そこが難しいところですね

338
00:19:08,420 --> 00:19:10,920
あとリソースバンドの扱いの難しさとかもありました

339
00:19:10,920 --> 00:19:13,680
その辺を軽減するために

340
00:19:13,680 --> 00:19:16,480
Mergeable Libraryが改善策になり得るので

341
00:19:16,480 --> 00:19:19,278
今後調査検討を進めていきたいと思っています

342
00:19:19,278 --> 00:19:24,778
まだまだ各チームに導入してもらうのがこれからなので

343
00:19:24,778 --> 00:19:28,058
俺たちの戦いはこれからだという気持ちで

344
00:19:28,058 --> 00:19:30,078
改善を進めていきたいと思います

345
00:19:30,078 --> 00:19:33,500
参考資料をいろいろと貼っていますが

346
00:19:33,500 --> 00:19:35,940
またスライドを共有するので

347
00:19:35,940 --> 00:19:37,640
見てみてください

348
00:19:37,640 --> 00:19:40,140
ということで皆さん楽しい

349
00:19:40,140 --> 00:19:41,838
Xcode Preview 生活を

350
00:19:41,838 --> 00:19:43,740
お過ごしいただければと思います

351
00:19:43,740 --> 00:19:46,000
発表は以上ですありがとうございました

352
00:19:46,000 --> 00:19:54,058
はい池田さん発表ありがとうございました

353
00:19:54,058 --> 00:19:57,259
それではQ&Aに入りたいと思います

354
00:19:57,259 --> 00:20:00,078
コメントご感想やご質問のある方は

355
00:20:00,078 --> 00:20:01,500
挙手をお願いいたします

356
00:20:05,940 --> 00:20:08,858
いらっしゃらないですか

357
00:20:08,858 --> 00:20:15,078
満員でね人がいっぱいいらっしゃるんできっと手が上がると思ってるんですけど

358
00:20:15,078 --> 00:20:18,538
皆さん勇気を持って手を上げてくださる方はいませんか

359
00:20:18,538 --> 00:20:22,980
じゃあ前方の方お願いします

360
00:20:22,980 --> 00:20:29,920
はいすごく興味深い発表でした

361
00:20:29,920 --> 00:20:30,519
ありがとうございます

362
00:20:30,519 --> 00:20:37,259
アセットを埋め込むみたいなところがあったと思うんですけど

363
00:20:37,259 --> 00:20:41,098
それはどういうふうにやっているのかが気になりました

364
00:20:41,098 --> 00:20:46,939
アセットの埋め込みがどういうふうかということなんですが

365
00:20:46,939 --> 00:20:49,278
これは単純に言えば

366
00:20:49,278 --> 00:20:53,640
普段はアプリターゲットにこの Media.xcassets を

367
00:20:53,640 --> 00:20:57,759
リソースとして追加しているんですけど

368
00:20:57,759 --> 00:21:00,140
これを 重複するんだけど

369
00:21:00,140 --> 00:21:04,077
こっちのSharedUICommonMediaAssetsにも追加しちゃうと

370
00:21:04,077 --> 00:21:10,019
そうするとこのSharedUICommonMediaAssets.frameworkの中に

371
00:21:10,019 --> 00:21:12,857
これが埋め込まれますということですね

372
00:21:12,857 --> 00:21:18,298
ただそのまま製品版のアプリにこれが入ってしまうと

373
00:21:18,298 --> 00:21:20,920
余計でアプリも重くなってしまうので

374
00:21:20,920 --> 00:21:23,097
これをディベロップメントアセット

375
00:21:23,097 --> 00:21:25,939
このリソースのパスを指定しておくと

376
00:21:25,939 --> 00:21:28,239
製品版をアーカイブするときには

377
00:21:28,239 --> 00:21:32,577
このフレームワークからこれが取り除かれるということですね

378
00:21:32,577 --> 00:21:37,159
ディベロップメントアセットのパスに追加しておくと

379
00:21:37,159 --> 00:21:37,798
無視される

380
00:21:37,798 --> 00:21:39,439
はい そうですね

381
00:21:39,439 --> 00:21:46,759
なのでこのパス自体はこのターゲットの依存のソースというか

382
00:21:46,759 --> 00:21:51,939
コードと一緒に追加してかつディベロップメントアセットにも指定する

383
00:21:51,939 --> 00:21:54,597
2カ所に指定するということになりますね

384
00:21:54,597 --> 00:21:55,838
なるほどありがとうございます

385
00:21:55,838 --> 00:21:59,097
はいありがとうございました

386
00:21:59,097 --> 00:22:04,439
他の方で質問のある方いらっしゃいましたら挙手をよろしくお願いいたします

387
00:22:08,680 --> 00:22:10,240
いらっしゃらないでしょうか

388
00:22:10,240 --> 00:22:18,439
はい前方の方お願いします

389
00:22:18,439 --> 00:22:22,058
興味深い発表ありがとうございました

390
00:22:22,058 --> 00:22:27,558
ちょっとだけ最後のところで導入が少しずつ始まっているというところだったんですけど

391
00:22:27,558 --> 00:22:31,019
実際に Preview ができるようになって

392
00:22:31,019 --> 00:22:34,097
チームとしていいフィードバックだったりとか

393
00:22:34,097 --> 00:22:38,597
声が聞けたみたいなものがあれば知りたいなと思いました

394
00:22:38,597 --> 00:22:45,199
導入後の開発チーム側のフィードバックという部分なんですが

395
00:22:45,199 --> 00:22:51,358
現時点でまだ明確にこれでめちゃくちゃはかどったよとか

396
00:22:51,358 --> 00:22:56,078
めっちゃ助かったよっていう声とかを直接もらったり

397
00:22:56,078 --> 00:23:01,259
もしくはアンケートで聞いてみるとかそういうところはできてはいないんですけれども

398
00:23:01,259 --> 00:23:04,278
このアナウンスをした後に

399
00:23:04,278 --> 00:23:11,118
実際に自分たちのチームに対するビルド系に対する問い合わせをするチャンネルなので

400
00:23:11,118 --> 00:23:17,058
試そうとしたんだけどこういうケースでうまくいかないんだけどどうしたらいいっていう話があって

401
00:23:17,058 --> 00:23:21,960
という形だったりとか実際に導入しようとしたプリリクエストを見に行って

402
00:23:21,960 --> 00:23:25,778
こっちからこの設定で大丈夫だよっていうレビューをしたりとか

403
00:23:25,778 --> 00:23:29,159
っていうやりとりはしていますね

404
00:23:29,159 --> 00:23:34,097
なので実際に動きがあるっていうこと自体は観測できている状態で

405
00:23:34,097 --> 00:23:40,519
これによって実際どれだけ開発チーム側で生産性が上がったとか

406
00:23:40,519 --> 00:23:45,597
UI構築の開発体験が改善したかというところは

407
00:23:45,597 --> 00:23:50,479
どのように期待かなというところではまだあります

408
00:23:50,479 --> 00:23:51,460
ありがとうございます

409
00:23:51,460 --> 00:23:54,858
ありがとうございます

410
00:23:54,858 --> 00:23:58,659
ニコ生の方から一つ質問らしきものが来ていて

411
00:23:58,659 --> 00:23:59,939
それをお伺いしたいんですけど

412
00:23:59,939 --> 00:24:02,979
この取り組みのモチベーションというところで

413
00:24:02,979 --> 00:24:09,519
Xcode Previewsを使うとUI的にはやっぱり開発上相当時間節約になるんですかねというような質問が来てるんですけど

414
00:24:09,519 --> 00:24:13,077
今後とかに対するインパクトってどんな感じなんでしょうか

415
00:24:13,077 --> 00:24:21,160
そうですね Preview を使ってUI開発が加速するかというところと思うんですが

416
00:24:21,160 --> 00:24:28,939
まずLINEアプリをクリーンビルドすると

417
00:24:28,939 --> 00:24:30,920
サブビルダーも大変ですが

418
00:24:30,920 --> 00:24:36,337
クリーンビルドすると十数分から倍開發速度の分ぐらいかかることがあります

419
00:24:36,337 --> 00:24:46,598
ちょっと特定のモジュールのUI変更してアプリビルドし直していっているときも数分かかっちゃったりするんですね

420
00:24:46,598 --> 00:24:55,618
なのでそのUI構築をしてアプリを起動するまでっていうのがアプリの規模的に非常に時間がかかりがちなので

421
00:24:56,019 --> 00:25:02,519
できるだけ20分自体のビルドと実行っていうのをどれだけ減らせるかっていうところが

422
00:25:02,519 --> 00:25:08,019
結構開発の体験の向上に効くのかなということがあって

423
00:25:08,019 --> 00:25:11,920
 Preview の導入っていうのを以前からやりたかったんだけど

424
00:25:11,920 --> 00:25:15,759
Xcodeが対応しなくてできなかったのがやっとできるようになって

425
00:25:15,759 --> 00:25:19,680
満を持してやり始めたっていう流れになっています

426
00:25:19,680 --> 00:25:25,680
アプリ自体を短くするっていうのも当然やっていきたいところなんですが

427
00:25:25,680 --> 00:25:29,720
まずはアプリのビルドをどれだけ避けるかというところも

428
00:25:29,720 --> 00:25:33,298
この Preview で狙っていこうということになります

429
00:25:33,298 --> 00:25:35,259
はいありがとうございます

430
00:25:35,259 --> 00:25:39,837
それではQ&Aは以上とさせていただいて

431
00:25:39,837 --> 00:25:42,759
次は1分間フィードバックに移りたいと思います

432
00:25:55,680 --> 00:26:03,618
それではQ&Aは以上とさせていただいて

433
00:26:03,618 --> 00:26:06,500
次は1分間フィードバックに移りたいと思います
