1
00:00:08,000 --> 00:00:13,419
那麼，我將以「大型 app 中實現 Xcode Previews 的實用化之路」為題進行演講

2
00:00:13,419 --> 00:00:14,380
請多多指教

3
00:00:14,380 --> 00:00:16,519
首先，先做一下自我介紹

4
00:00:16,519 --> 00:00:18,559
我是池翔，池田翔

5
00:00:18,559 --> 00:00:23,739
就職於 LINE Yahoo，隸屬於 LINE 應用程式的 MDX 團隊

6
00:00:23,859 --> 00:00:30,760
我們的團隊以「改善開發者體驗與提升開發生產力」為使命而工作

7
00:00:30,760 --> 00:00:36,320
主要負責 iOS 應用的建置系統，以及 CI/CD 的維護等相關工作

8
00:00:36,320 --> 00:00:39,280 
也在 GitHub 上從事各種開發活動

9
00:00:40,200 --> 00:00:47,133
是 Swift committer，過去也維護過許多不同的 OSS

10
00:00:47,133 --> 00:00:52,865
過去我曾在 iOSDC 登台過 5 次，但都是 Lightning Talk

11
00:00:52,865 --> 00:00:55,100
Regular Talk 這倒是第一次

12
00:00:55,133 --> 00:00:57,399
我其實有點緊張

13
00:00:57,432 --> 00:00:58,966
還請大家多多指教

14
00:00:59,000 --> 00:01:02,100
總之，就是 LINE app

15
00:01:02,100 --> 00:01:05,933
標題中提到的「大規模 app」指的就是 LINE

16
00:01:05,965 --> 00:01:11,233
今天的議程如下所示

17
00:01:11,233 --> 00:01:12,965
我們就一個一個來看吧

18
00:01:13,000 --> 00:01:20,000
首先，我想談談 LINE iOS app 的背景與它所面臨的課題

19
00:01:20,033 --> 00:01:25,465
LINE iOS app 的特徵大致是這樣的

20
00:01:25,465 --> 00:01:29,400
如同最近許多 app 一樣

21
00:01:29,400 --> 00:01:33,533
我們採用了 multi-module 架構，由數百個 module 所構成

22
00:01:33,566 --> 00:01:36,200
也就是因為 module 非常多

23
00:01:36,200 --> 00:01:38,132
為了加快 app 的啟動速度

24
00:01:38,132 --> 00:01:40,733
我們大規模地使用了 static framework

25
00:01:40,733 --> 00:01:44,465
雖說進行了模組化

26
00:01:44,500 --> 00:01:48,433
仍有一些 legacy 的部分還無法模組化，

27
00:01:48,433 --> 00:01:51,933
再加上光是整合這數百個 module 這件事

28
00:01:51,933 --> 00:01:55,000
application target 本身就已經相當巨大

29
00:01:55,033 --> 00:01:57,766
因此要直接 preview 整個 application target

30
00:01:57,766 --> 00:01:59,632
我們的架構是相當不適合這麼做的

31
00:01:59,665 --> 00:02:03,766
讓我來大致介紹一下目前的開發規模

32
00:02:03,766 --> 00:02:06,533
code 行數超過 250 萬行

33
00:02:06,566 --> 00:02:08,432
Xcode project 超過 600 個

34
00:02:08,465 --> 00:02:12,400
target 數量扣除 test target 後仍超過 800 個

35
00:02:12,400 --> 00:02:14,800
此外，pre-built framework 的數量

36
00:02:14,831 --> 00:02:19,264
也就是指內部的 package 或外部的 library

37
00:02:19,300 --> 00:02:22,500
透過 giginet 提供的叫一個 Scipio 的工具

38
00:02:22,500 --> 00:02:25,098
將它們製作成 pre-built XCFramework 來使用的

39
00:02:25,133 --> 00:02:28,366
數量也超過 150 個，規模相當可觀

40
00:02:28,400 --> 00:02:32,066
這部分可能有點重複

41
00:02:32,066 --> 00:02:34,800
LINE iOS app 有非常多的 module

42
00:02:34,800 --> 00:02:36,699
如果將這些都用 dynamic link 來連結

43
00:02:36,733 --> 00:02:39,233
app 的啟動時間就會變得非常慢

44
00:02:39,233 --> 00:02:41,664
因此我們是作為 static framework 來使用

45
00:02:41,664 --> 00:02:47,264
雖然最近的 iOS 中 dyld (dynamic link editor) 有所進化

46
00:02:47,300 --> 00:02:50,233
也有了 cache 機制，在某些方面是變快了沒錯

47
00:02:50,233 --> 00:02:51,966
但我們目前仍是使用 static framework

48
00:02:52,000 --> 00:02:55,366
不過，這在 Preview 方面就造成了困擾

49
00:02:55,366 --> 00:02:59,066
在 Xcode 15 之前，如果不是 dynamic framework

50
00:02:59,066 --> 00:03:01,764
是無法 preview 該 module 的

51
00:03:01,800 --> 00:03:06,066
這算是 Xcode Preview 執行引擎的

52
00:03:06,066 --> 00:03:07,866
一個技術上的限制

53
00:03:07,900 --> 00:03:10,133
因此在 LINE iOS app 上

54
00:03:10,133 --> 00:03:13,664
實質上一直處於無法使用 Preview 的狀態

55
00:03:13,699 --> 00:03:17,931
這時，迎來了一個轉機

56
00:03:17,931 --> 00:03:21,400
如同方才所說，Xcode 15 之前

57
00:03:21,431 --> 00:03:24,264
只有 dynamic framework 才能使用 Preview

58
00:03:24,264 --> 00:03:26,931
到了 Xcode 16，總算連 static framework

59
00:03:26,931 --> 00:03:30,233
和 static library 的支援也加上去了

60
00:03:30,264 --> 00:03:33,066
這就是 Release Note 上所 highlight 的重點

61
00:03:33,066 --> 00:03:36,199
於是，我們便開始進行驗證

62
00:03:36,233 --> 00:03:40,966
實際要在 LINE iOS 的 workspace 中測試時

63
00:03:41,000 --> 00:03:44,300
我覺得直接拿現有的 module 來測試有點麻煩

64
00:03:44,300 --> 00:03:48,466
於是就試著做了一個最小需求的小型 module 來跑跑看

65
00:03:48,500 --> 00:03:52,431
確實確認到即便是 static framework，Preview 也能正常運作

66
00:03:52,431 --> 00:03:54,233
太棒了！

67
00:03:54,264 --> 00:03:57,431
雖然是這樣，但有一點注意事項

68
00:03:57,431 --> 00:04:00,366
就是必須使用新的執行引擎

69
00:04:00,400 --> 00:04:06,331
從 16 版開始，執行引擎本身就換成了全新的版本

70
00:04:06,366 --> 00:04:08,566
不過還是有「使用舊版執行引擎」的設定

71
00:04:08,566 --> 00:04:10,400
必須把這個選項關掉

72
00:04:10,431 --> 00:04:14,366
把 Editor > Canvas 下的 Uses Legacy Previews Execution 這個選項設為 Off

73
00:04:14,366 --> 00:04:19,165
接著，我試著用現有的 module 來正式測試

74
00:04:19,199 --> 00:04:24,833
結果發現，只要用了 available 
Preview 就會 crash

75
00:04:24,833 --> 00:04:30,033
這個問題在 LINE app 的 code base 中影響範圍相當大

76
00:04:30,064 --> 00:04:33,000
並不是只改掉一部分就能了事的

77
00:04:33,033 --> 00:04:35,966
嚴重到如果問題不解決，LINE app 根本無法實際應用的程度

78
00:04:35,966 --> 00:04:39,033
於是，我就向 Apple 提交了 Feedback

79
00:04:39,033 --> 00:04:40,966
開始了等待修正的日子

80
00:04:41,000 --> 00:04:44,733
我用這個 FB 編號和標題提交了 Feedback

81
00:04:44,733 --> 00:04:47,766
內容大致是像這樣

82
00:04:47,766 --> 00:04:50,800
寫了 if available 和 OS 版本

83
00:04:50,833 --> 00:04:54,365
這時，如果實際 project 端的 target 的

84
00:04:54,365 --> 00:04:58,300
deployment target 低於這個版本

85
00:04:58,300 --> 00:05:00,100
Preview 的執行引擎

86
00:05:00,132 --> 00:05:02,833
用來判斷該執行環境的 symbol

87
00:05:02,833 --> 00:05:05,600
會因為找不到而 crash

88
00:05:05,600 --> 00:05:07,699
就這樣等著等著

89
00:05:07,733 --> 00:05:10,865
到了 Xcode 16.3，這個 bug 總算被修正了

90
00:05:10,865 --> 00:05:11,932
太棒了！

91
00:05:11,932 --> 00:05:13,333
總而言之

92
00:05:13,365 --> 00:05:16,165
看到自己提交的 Feedback

93
00:05:16,165 --> 00:05:19,665
出現在 Xcode Release Note 的修正清單裡

94
00:05:19,665 --> 00:05:21,466
真的是一次非常開心的體驗

95
00:05:21,500 --> 00:05:22,766
於是呢

96
00:05:22,766 --> 00:05:26,365
實際執行了剛才 Feedback 裡附上的

97
00:05:26,365 --> 00:05:28,733
Preview code，它確實能動了

98
00:05:28,733 --> 00:05:29,899
出現了「aaa」的字樣

99
00:05:29,932 --> 00:05:30,966
Preview 在運作了

100
00:05:31,000 --> 00:05:32,233
太棒了！

101
00:05:32,233 --> 00:05:35,632
總之，可喜可賀、可喜可賀

102
00:05:35,660 --> 00:05:39,333
以上，本次演講到此...

103
00:05:39,333 --> 00:05:40,665
還沒結束

104
00:05:41,920 --> 00:05:43,399
也就是說

105
00:05:43,399 --> 00:05:45,632
接下來我會分享

106
00:05:45,632 --> 00:05:47,266
為了達到實用化

107
00:05:47,300 --> 00:05:48,564
我們到底發現了

108
00:05:48,564 --> 00:05:52,064
哪些課題，以及我們是如何應對的

109
00:05:52,100 --> 00:05:55,033
我想來談談這部分

110
00:05:55,399 --> 00:05:58,365
接下來主要會談論三個點

111
00:05:58,365 --> 00:06:02,600
build scheme 的管理、減少 Preview 對象的相依性、

112
00:06:02,632 --> 00:06:06,966
以及圖片或在地化等 resource 的讀取

113
00:06:07,500 --> 00:06:09,966
第一點是 build scheme 的管理

114
00:06:11,132 --> 00:06:14,564
當要用 Xcode Previews 來 preview 特定的 component

115
00:06:14,600 --> 00:06:18,733
也就是它所在的 target module 時

116
00:06:18,733 --> 00:06:20,432
Xcode 的 build scheme

117
00:06:20,432 --> 00:06:24,266
就是最上方執行按鈕旁邊那個地方

118
00:06:24,300 --> 00:06:27,399
我們要從這裡選擇要 build 哪個 target scheme

119
00:06:27,399 --> 00:06:29,699
然後才能執行 Preview

120
00:06:29,699 --> 00:06:32,500
因此，我們需要一個專門給它用的 scheme

121
00:06:32,533 --> 00:06:37,899
如果想做這件事，就要選擇實作這個 component 的 target，是吧

122
00:06:37,899 --> 00:06:43,300
然而，LINE iOS 的 project 有數百個 module

123
00:06:43,333 --> 00:06:46,500
如果馬上幫每個不同的 target 都各建一個 build scheme

124
00:06:46,500 --> 00:06:49,766
列表就會像後面那樣整個滿出來

125
00:06:49,800 --> 00:06:51,733
會變得很麻煩，非常不切實際

126
00:06:51,733 --> 00:06:53,432
會變得根本沒辦法用

127
00:06:53,432 --> 00:06:57,266
就算我們只鎖定有包含 UI 的「UI module」

128
00:06:57,300 --> 00:06:59,600
數量還是太多了

129
00:06:59,600 --> 00:07:03,733
而且，app 的功能開發

130
00:07:03,733 --> 00:07:07,033
常會依照 module 來區分負責的團隊

131
00:07:07,033 --> 00:07:10,533
如果列表上出現了

132
00:07:10,533 --> 00:07:13,033
跟自己團隊無關的東西，也會形成干擾

133
00:07:13,064 --> 00:07:16,199
所以，在實際應用上

134
00:07:16,199 --> 00:07:19,000
我們需要一個機制，讓我們可以

135
00:07:19,033 --> 00:07:22,233
只建立和顯示自己需要的 build scheme

136
00:07:22,233 --> 00:07:26,766
於是，我們決定使用 XcodeGen 建立 scheme 的機制中

137
00:07:26,800 --> 00:07:30,632
Scheme Management 的「Shared」和「IsShown」這兩個設定

138
00:07:30,632 --> 00:07:32,432
在這裡

139
00:07:32,466 --> 00:07:35,800
那 600 多個 Xcode project

140
00:07:35,800 --> 00:07:39,800
我們是使用一個叫 XcodeGen 的工具，透過 YAML 來產生 Xcode project

141
00:07:39,833 --> 00:07:40,632
來進行控制的

142
00:07:40,632 --> 00:07:43,500
我們使用的是它裡面的 scheme 生成設定

143
00:07:43,533 --> 00:07:47,132
我們將 scheme 建立為「Shared」

144
00:07:47,132 --> 00:07:49,600
讓 scheme 本身可以在團隊間共享

145
00:07:49,632 --> 00:07:51,699
同時設定「IsShown」

146
00:07:51,699 --> 00:07:54,064
讓它預設是隱藏的

147
00:07:54,100 --> 00:07:58,800
只有想用的人才在自己的電腦上把它打開，透過這種方式來控制

148
00:07:58,800 --> 00:08:03,033
這個顯示/隱藏的狀態，是依據 user 來管理的

149
00:08:03,033 --> 00:08:05,833
它會存在 Xcode project 裡的 xcuserdata

150
00:08:05,865 --> 00:08:10,165
這個 user 專屬目錄底下的設定檔中

151
00:08:10,165 --> 00:08:14,199
在 Scheme Management 這個畫面中

152
00:08:14,233 --> 00:08:16,600
建立時，「Shared」會是打勾的狀態

153
00:08:16,600 --> 00:08:22,033
一開始左邊「Show」的核取方塊是取消的

154
00:08:22,064 --> 00:08:27,033
使用者在自己的電腦上把它打勾，然後關閉視窗，就可以用了

155
00:08:27,033 --> 00:08:32,365
我們也在 XcodeGen 端準備了套用這項設定的 template

156
00:08:32,399 --> 00:08:36,000
這樣大家就不用一個一個去寫左邊的設定

157
00:08:36,000 --> 00:08:40,666
只要在 template 裡寫好，就可以直接套用

158
00:08:41,365 --> 00:08:44,932
第二點，是關於減少 Preview 對象的相依性

159
00:08:45,865 --> 00:08:50,133
LINE 的 multi-module 架構大致是長這個樣子

160
00:08:50,166 --> 00:08:58,365
分為 Feature、Shared、Utility 這幾個 layer，底下還有外部 library、內部 package 等等

161
00:08:58,365 --> 00:09:03,399
上層 layer 可以依賴下層 layer，但下層 layer 禁止依賴上層

162
00:09:03,432 --> 00:09:08,932
此外，在各 layer 中又分離出 UI module 和 Logic module

163
00:09:08,932 --> 00:09:11,100
UI 可以依賴 Logic

164
00:09:11,100 --> 00:09:14,432
但 Logic 禁止依賴 UI

165
00:09:14,466 --> 00:09:19,466
在 UI 依賴 Logic module 的架構下

166
00:09:19,500 --> 00:09:22,666
我們想 preview 的 UI component

167
00:09:22,666 --> 00:09:25,166
當然是放在 UI module 裡面，對吧

168
00:09:25,166 --> 00:09:26,365
但是

169
00:09:26,365 --> 00:09:29,298
因為想 preview UI module

170
00:09:29,298 --> 00:09:32,200
所以選擇了 UI module 的 scheme，觸發了 build

171
00:09:32,231 --> 00:09:35,666
這麼一來，Logic module 和它的相依項目

172
00:09:35,700 --> 00:09:37,533
當然也必須跟著一起 build

173
00:09:37,533 --> 00:09:40,966
這時，如果 Logic module 又依賴了一大堆東西

174
00:09:40,966 --> 00:09:43,100
明明只是想 preview 個 UI

175
00:09:43,133 --> 00:09:46,466
卻得連帶 build 一大堆 Logic 的相依項目

176
00:09:46,466 --> 00:09:48,500
導致 build 的時間變得很長

177
00:09:48,500 --> 00:09:54,298
更嚴重的時候，Xcode 甚至無法正確 build 或 preview

178
00:09:54,331 --> 00:09:59,000
Preview 的 canvas 畫面會一直處於 loading 狀態

179
00:09:59,000 --> 00:10:03,200
既不吐 error，也顯示不出 preview

180
00:10:03,200 --> 00:10:06,298
關於這點該如何解決

181
00:10:06,331 --> 00:10:08,365
我們在 UI module 之外

182
00:10:08,365 --> 00:10:12,331
另外定義了一種「Previable UI module」

183
00:10:12,331 --> 00:10:15,731
並提案寫入了 guideline

184
00:10:15,764 --> 00:10:20,231
我們規定這種 module 不可以依賴 Logic module

185
00:10:20,231 --> 00:10:21,899
是「禁止」依賴

186
00:10:21,932 --> 00:10:25,865
那像是按下按鈕時的 action 該怎麼辦呢？

187
00:10:25,865 --> 00:10:27,432
關於這點

188
00:10:27,466 --> 00:10:31,133
由更上層的 UI module，同時依賴 Logic

189
00:10:31,133 --> 00:10:34,066
和不含 Logic 的 Previable UI

190
00:10:34,100 --> 00:10:38,633
再透過 closure 或 binding 的方式將 Logic 注入

191
00:10:38,633 --> 00:10:44,231
我們把這種 module 命名為可 Preview 的狀態

192
00:10:44,264 --> 00:10:49,932
定義出「想 preview 的 component 請實作在這裡」

193
00:10:49,932 --> 00:10:53,200
透過這種方式來分離和輕量化相依性

194
00:10:53,231 --> 00:10:59,133
當新的 module、或是現有相依性過多的 module 想使用 Preview 時

195
00:10:59,166 --> 00:11:01,764
我們就提倡用這種方式去分離它

196
00:11:03,264 --> 00:11:05,500
好，那麼第三點，也是最後一點

197
00:11:05,831 --> 00:11:09,966
是關於圖片或在地化（localization）等 resource 的讀取

198
00:11:10,200 --> 00:11:12,298
這部分是個相當困難的點

199
00:11:13,831 --> 00:11:19,264
LINE app 我想也是因為過去的歷史包袱

200
00:11:19,264 --> 00:11:23,798
許多橫跨整個 app、或是多個功能共通使用的

201
00:11:23,798 --> 00:11:27,100
圖片或在地化字串等 resource

202
00:11:27,100 --> 00:11:30,865
都是被包在 LINE app 最上層的 application target 主體中

203
00:11:30,899 --> 00:11:33,633
是像這樣內嵌的形式

204
00:11:34,200 --> 00:11:36,100
各個被分離出去的 module

205
00:11:36,133 --> 00:11:38,831
在想要取用那些共通 resource 的時候

206
00:11:38,831 --> 00:11:40,764
會透過 Bundle.main

207
00:11:40,764 --> 00:11:43,066
去存取那些被包在 app 裡的 resource

208
00:11:43,066 --> 00:11:45,166
是這樣的一個機制

209
00:11:45,831 --> 00:11:47,533
平常這樣做是沒有問題的

210
00:11:47,566 --> 00:11:52,831
不過，直接用字串去存取很麻煩

211
00:11:52,831 --> 00:11:53,932
型別上也不安全

212
00:11:53,932 --> 00:11:56,865
所以我們透過 code generation 產生的 accessor code

213
00:11:56,899 --> 00:11:58,633
定義成共用 module 來使用

214
00:11:58,633 --> 00:12:00,966
大家都是透過它來存取

215
00:12:01,000 --> 00:12:04,399
這在 Preview 的時候就麻煩了

216
00:12:04,432 --> 00:12:09,133
在 Preview 時，存取 Bundle.main 會出錯

217
00:12:09,133 --> 00:12:13,365
為什麼呢？因為 Xcode Preview 的執行環境

218
00:12:13,365 --> 00:12:20,066
它的 host app，是一個叫 XCPreviewAgent.app 的、由 Xcode 提供的 app

219
00:12:20,100 --> 00:12:26,831
是由這個 app 去 load 要 preview 的 module 並顯示出來的

220
00:12:26,831 --> 00:12:31,166
這時，如果 module 端去存取 Bundle.main

221
00:12:31,166 --> 00:12:35,399
那個 Bundle.main 會指向 XCPreviewAgent.app 本身

222
00:12:35,432 --> 00:12:38,731
想當然，這個 Xcode 提供的 app

223
00:12:38,731 --> 00:12:42,000
裡面並不會包有我們 LINE app 用的 resource

224
00:12:42,000 --> 00:12:45,133
所以用 Bundle.main 去存取也找不到 resource

225
00:12:45,166 --> 00:12:49,264
如果又用了 force unwrap，自然就會 crash 了

226
00:12:49,264 --> 00:12:56,600
作為解決方案，我們決定使用「Development Assets」

227
00:12:56,633 --> 00:13:01,399
我們利用這個功能，在 Accessor Code 用的共用模組中

228
00:13:01,432 --> 00:13:04,865
暫時性地將 resource 嵌入到這裡，來代替 app

229
00:13:04,865 --> 00:13:09,166
Development Assets 是用來指定 Preview 用的圖片 resource

230
00:13:09,200 --> 00:13:14,365
或 Mock data 等，不會包含在正式版 app 裡的 asset 或 source code 路徑的功能

231
00:13:14,399 --> 00:13:16,066
它在 archive build 時

232
00:13:16,100 --> 00:13:19,365
也就是 xcodebuild 的 archive  command action 時

233
00:13:19,365 --> 00:13:21,666
會被排除在 build 對象之外

234
00:13:21,700 --> 00:13:24,731
這功能 Swift source code 能用，resource 也能用

235
00:13:24,731 --> 00:13:26,533
兩者皆可

236
00:13:26,533 --> 00:13:31,798
在 Xcode 的設定中，像這樣在 target 設定的 General 底下

237
00:13:31,831 --> 00:13:34,166
最下面有個 Development Assets 欄位

238
00:13:34,166 --> 00:13:36,533
把路徑加到這裡就行了

239
00:13:36,533 --> 00:13:40,932
在 build setting 裡，則對應 DEVELOPMENT_ASSET_PATHS 這個設定

240
00:13:42,966 --> 00:13:45,731
我們利用這項設定，在這個名為 SharedUICommonMediaAssets

241
00:13:45,731 --> 00:13:49,033
也就是定義了共通的 Accessor Code  的 module 中

242
00:13:49,066 --> 00:13:52,899
將平常嵌在 app 主程式裡的 Media.xcassets

243
00:13:52,932 --> 00:13:55,932
改成只在 Preview 時嵌入到這個 module 裡

244
00:13:55,932 --> 00:14:02,000
並且，把平常透過 Bundle.main 存取 resource 的 bundle 指向

245
00:14:02,000 --> 00:14:05,133
替換成指向自己的 module

246
00:14:05,133 --> 00:14:10,533
指向自己的 Accessor Code 所在的 module

247
00:14:10,566 --> 00:14:15,865
這樣一來，就算在 Preview 時，也能正確找到想存取的 resource 了

248
00:14:15,865 --> 00:14:22,331
這張圖是替換 bundle 指向的 code 範例

249
00:14:22,365 --> 00:14:25,666
首先，Preview 基本上都是 Debug build

250
00:14:25,700 --> 00:14:27,731
所以先限定在 Debug 模式

251
00:14:27,731 --> 00:14:31,166
接著，在 Preview 執行時

252
00:14:31,200 --> 00:14:35,865
系統會定義一個名為 XCODE_RUNNING_FOR_PREVIEWS 的環境變數

253
00:14:35,899 --> 00:14:38,731
藉此就可以判斷是否在 Preview 環境下執行

254
00:14:38,731 --> 00:14:42,231
這時，雖然有點 tricky

255
00:14:42,264 --> 00:14:45,899
透過 Bundle(for: Class.self) 取得的路徑

256
00:14:45,932 --> 00:14:47,365
那個路徑

257
00:14:47,365 --> 00:14:50,764
在 Preview 的執行環境下

258
00:14:50,764 --> 00:14:55,365
 Bundle(for:) 會回傳 Debug-iphonesimulator 的路徑

259
00:14:55,365 --> 00:14:56,133
雖然很不可思議

260
00:14:56,166 --> 00:14:58,399
但 Xcode build 完的

261
00:14:58,432 --> 00:15:01,466
 SharedUICommonMediaAssets

262
00:15:01,466 --> 00:15:03,466
這個 framework build 完的成品

263
00:15:03,466 --> 00:15:04,100
會存在於那裡

264
00:15:04,133 --> 00:15:06,533
所以我們就把那個 framework 的路徑當作 bundle 來用

265
00:15:06,533 --> 00:15:07,932
就可以了

266
00:15:07,932 --> 00:15:09,932
這樣就能存取到這個 bundle 裡的

267
00:15:09,966 --> 00:15:13,298
assets 了

268
00:15:13,331 --> 00:15:15,831
就是這樣一個範例

269
00:15:16,000 --> 00:15:18,298
這樣基本上就沒問題了，不過

270
00:15:18,331 --> 00:15:19,432
有一部分的 module

271
00:15:19,432 --> 00:15:21,666
是直接使用 UIImage(named:)

272
00:15:21,700 --> 00:15:23,700
沒有正確指定 bundle

273
00:15:23,700 --> 00:15:27,466
這樣下去還是會存取到 Bundle.main

274
00:15:27,500 --> 00:15:29,633
所以我們把那些地方改成

275
00:15:29,633 --> 00:15:32,365
使用下面這種 code generation 產生的 accessor code

276
00:15:32,365 --> 00:15:35,399
這樣就能確保 bundle 被正確替換了

277
00:15:35,432 --> 00:15:39,331
這樣處理後，大致上就沒問題了

278
00:15:39,331 --> 00:15:43,066
接著來談談目前的狀況與未來的展望

279
00:15:44,399 --> 00:15:48,000
再次強調，我們成功驗證了 static framework 是可行的

280
00:15:48,033 --> 00:15:52,566
並且透過今天介紹的各種事前準備

281
00:15:52,600 --> 00:15:54,666
已經能夠在一定程度上完善整個環境

282
00:15:54,666 --> 00:15:58,231
接著我們為了讓開發者、各開發團隊能開始使用

283
00:15:58,231 --> 00:15:59,731
而製作了 guideline

284
00:15:59,731 --> 00:16:02,899
並向各開發團隊進行了宣導

285
00:16:02,932 --> 00:16:07,600
從這裡開始，就進入了讓各開發團隊實際使用

286
00:16:07,633 --> 00:16:09,831
也就是導入的階段

287
00:16:09,831 --> 00:16:13,331
目前，剛剛提到的「Previwable Target」

288
00:16:13,365 --> 00:16:15,100
已經定義了大約 5 個

289
00:16:15,100 --> 00:16:16,899
自宣導以來增加了 3 個

290
00:16:16,932 --> 00:16:20,466
雖然不多，但已經漸漸開始導入了

291
00:16:20,500 --> 00:16:24,731
關於未來的展望

292
00:16:24,731 --> 00:16:26,764
如同我剛才所說

293
00:16:26,764 --> 00:16:32,500
Xcode Previews 本身還有很多不穩定的地方

294
00:16:32,533 --> 00:16:40,133
我們期待 Apple 能持續為 Xcode 追加新功能並改善穩定性

295
00:16:40,133 --> 00:16:45,264
此外，當開發團隊實際開始導入時

296
00:16:45,298 --> 00:16:47,200
一定會產生各式各樣的疑問

297
00:16:47,231 --> 00:16:51,566
根據情況，可能還會發現「啊，這個 case 我們漏考慮了」

298
00:16:51,600 --> 00:16:53,000
我想會陸續發現很多這類問題

299
00:16:53,000 --> 00:16:55,932
我們會將這些部分持續反映到 guideline 中

300
00:16:55,932 --> 00:16:59,100
希望能打造出一份沒有疏漏的文件

301
00:16:59,133 --> 00:17:03,500
再來，我們也會透過內部的讀書會發表，傳達給各團隊

302
00:17:03,533 --> 00:17:07,164
或是舉辦 workshop，大家實際動手做做看

303
00:17:07,200 --> 00:17:10,598
希望藉此能逐步提高導入與採用的比例

304
00:17:10,598 --> 00:17:15,231
另外，作為這些措施的成效評估

305
00:17:15,266 --> 00:17:19,000
我們也希望能確實追蹤使用狀況

306
00:17:19,031 --> 00:17:21,932
像是「實際可以 preview 的 target」

307
00:17:21,932 --> 00:17:24,066
到底被定義了多少個

308
00:17:24,066 --> 00:17:30,298
以及「Preview 本身的數量」被定義了多少個，我們希望能測量這些數據

309
00:17:30,333 --> 00:17:33,164
並為此製作測量工具

310
00:17:33,200 --> 00:17:38,531
希望能做到定期執行並持續觀測

311
00:17:39,231 --> 00:17:41,700
最後，還有一個大魔王

312
00:17:41,731 --> 00:17:45,000
就是評估導入「Mergeable Library」

313
00:17:45,598 --> 00:17:48,298
到目前為止我們看到的這些問題

314
00:17:48,333 --> 00:17:53,231
絕大多數都是因為使用 static framework 所引起的

315
00:17:53,231 --> 00:17:56,932
因為這樣，導致相依的 module 一多，link 就會變得很慢

316
00:17:56,932 --> 00:17:59,400
Preview 就無法正常運作

317
00:17:59,400 --> 00:18:04,266
為了避免這種情況，我們才需要把 module 分離成 Previewable UI 之類的

318
00:18:04,298 --> 00:18:06,266
非得做這些事不可

319
00:18:06,266 --> 00:18:09,766
但是，如果導入了 Mergeable Library

320
00:18:09,766 --> 00:18:11,365
詳細內容我就先省略了

321
00:18:11,400 --> 00:18:16,566
它在 Debug build 時，會從 static link 變成 dynamic link

322
00:18:16,566 --> 00:18:23,664
這樣一來，在 Preview 時 link 的負擔，或許就能減輕也說不定

323
00:18:23,664 --> 00:18:26,200
關於 Mergeable Library 的詳情

324
00:18:26,231 --> 00:18:30,731
請參考 2023 年 iOSDC 中由我的隊友 GIGINET 先生所發表的演講，

325
00:18:30,731 --> 00:18:36,133
題為「透過 Mergeable Library 實現高速 app 啟動」，也請務必參考

326
00:18:36,133 --> 00:18:37,932
結論

327
00:18:37,964 --> 00:18:42,464
我們開始在 LINE iOS app 這樣的大規模 app 開發中

328
00:18:42,500 --> 00:18:44,833
導入 Xcode Preview

329
00:18:46,266 --> 00:18:48,964
我們仔細地盤點了會有哪些課題

330
00:18:48,964 --> 00:18:50,964
並一個一個地調查、解決

331
00:18:51,000 --> 00:18:53,865
也向 Xcode 提交 Feedback，請他們修正了 bug

332
00:18:53,865 --> 00:18:57,333
要在 static framework 上使用 Xcode Preview

333
00:18:57,333 --> 00:18:58,865
依然有許多門檻

334
00:18:58,900 --> 00:19:00,964
像是 Preview 本身的運作穩定性

335
00:19:00,964 --> 00:19:03,432
這部分，它的引擎是 JIT compile

336
00:19:03,432 --> 00:19:06,566
透過 JIT 在 link 之類的，這部分是關鍵

337
00:19:06,598 --> 00:19:08,400
也是困難點所在

338
00:19:08,400 --> 00:19:10,900
另外還有 resource bundle 的處理難處等等

339
00:19:10,900 --> 00:19:13,633
為了減輕這些問題

340
00:19:13,664 --> 00:19:16,464
Mergeable Library 或許能成為改善方案

341
00:19:16,464 --> 00:19:19,231
未來我們會持續往這個方向調查與評估

342
00:19:19,266 --> 00:19:24,766
要讓各團隊導入，才正要開始

343
00:19:24,766 --> 00:19:28,031
抱持著「我們的戰鬥才正要開始」的心情

344
00:19:28,031 --> 00:19:30,031
我們會持續推動改善

345
00:19:30,066 --> 00:19:33,464
我貼了許多參考資料

346
00:19:33,500 --> 00:19:35,932
之後會再分享投影片

347
00:19:35,932 --> 00:19:37,633
屆時再請大家看看

348
00:19:37,633 --> 00:19:40,133
那麼，祝大家有愉快的

349
00:19:40,133 --> 00:19:41,798
Xcode Preview 生活

350
00:19:41,833 --> 00:19:43,731
希望大家能享受

351
00:19:43,731 --> 00:19:45,964
我的演講到此結束，謝謝大家

352
00:19:52,066 --> 00:19:54,664
好的，謝謝池田先生的演講

353
00:19:54,964 --> 00:19:57,900
接著我們將進入 Q&A 環節

354
00:19:58,200 --> 00:20:00,700
有任何評論、感想或問題的朋友

355
00:20:00,700 --> 00:20:02,098
請舉手

356
00:20:08,333 --> 00:20:10,865
沒有人嗎？

357
00:20:11,200 --> 00:20:15,031
現場座無虛席，來了這麼多人，我以為一定會有人舉手的

358
00:20:15,964 --> 00:20:19,200
有沒有人願意鼓起勇氣舉手呢？

359
00:20:21,266 --> 00:20:24,098
啊，麻煩前面那位

360
00:20:27,633 --> 00:20:29,900
是，這是一場非常有收穫的演講

361
00:20:29,900 --> 00:20:30,519
非常感謝

362
00:20:30,519 --> 00:20:37,259
剛剛有提到把 asset 嵌入的部分

363
00:20:37,259 --> 00:20:41,098
想請教具體是怎麼做的

364
00:20:41,098 --> 00:20:46,939
關於 asset 要怎麼嵌入

365
00:20:46,939 --> 00:20:49,278
簡單來說

366
00:20:49,278 --> 00:20:53,640
平常我們會把這個 Media.xcassets 加到 app target 裡

367
00:20:53,640 --> 00:20:57,759
作為 resource 加進去

368
00:20:57,759 --> 00:21:00,140
把這個 雖然會重複

369
00:21:00,140 --> 00:21:04,077
也把它加到這邊的 SharedUICommonMediaAssets

370
00:21:04,077 --> 00:21:10,019
這樣一來，在 SharedUICommonMediaAssets.framework 裡面

371
00:21:10,019 --> 00:21:12,857
就會把它放進去了

372
00:21:12,857 --> 00:21:18,298
但如果就這樣直接把它放進正式版的 app 裡面

373
00:21:18,298 --> 00:21:20,920
會造成多餘的內容，app 也會變得更肥

374
00:21:20,920 --> 00:21:23,097
所以把它設成 Development Assets

375
00:21:23,097 --> 00:21:25,939
指定這個資源的路徑

376
00:21:25,939 --> 00:21:28,239
在做正式版的 Archive 時

377
00:21:28,239 --> 00:21:32,577
就會從這個 framework 裡面被移除

378
00:21:32,577 --> 00:21:37,159
也就是說只要加到 Development Assets 的路徑

379
00:21:37,159 --> 00:21:37,798
就會被忽略

380
00:21:37,798 --> 00:21:39,439
對，沒錯

381
00:21:39,439 --> 00:21:46,759
所以這些路徑同時要在 Target 的依賴來源中加入

382
00:21:46,759 --> 00:21:51,939
會跟程式碼一起加進來，並且同時在 Development Assets 裡指定

383
00:21:51,939 --> 00:21:54,597
等於要在兩個地方都設定

384
00:21:54,597 --> 00:21:55,838
原來如此，謝謝

385
00:21:56,838 --> 00:21:59,097
好，謝謝

386
00:21:59,097 --> 00:22:04,439
那麼，如果還有其他人有問題的話
請舉手

387
00:22:08,680 --> 00:22:10,240
沒有了嗎

388
00:22:15,240 --> 00:22:18,439
好的，請前排的那位

389
00:22:18,439 --> 00:22:22,058
謝謝精彩的分享

390
00:22:22,058 --> 00:22:27,558
在最後有提到已經開始逐步導入

391
00:22:27,558 --> 00:22:31,019
我想請問在能夠使用 Preview 之後

392
00:22:31,019 --> 00:22:34,097
團隊這邊有沒有一些不錯的回饋

393
00:22:34,097 --> 00:22:38,597
或是有哪些反饋聲音，想了解一下

394
00:22:38,597 --> 00:22:45,199
關於導入後開發團隊這邊的回饋

395
00:22:45,199 --> 00:22:51,358
目前還沒有明確到像是「這讓進度大幅加快」

396
00:22:51,358 --> 00:22:56,078
或是「幫了超大忙」這種直接的回饋

397
00:22:56,078 --> 00:23:01,259
也還沒有透過問卷蒐集這類資料

398
00:23:01,259 --> 00:23:04,278
不過告訴大家這件事之後

399
00:23:04,278 --> 00:23:11,118
在我們專門處理 Build 系統相關問題的內部頻道裡

400
00:23:11,118 --> 00:23:17,058
陸續有人詢問：「我想試試看，但在某些情況下不能正常運作，該怎麼辦？」
像這樣的問題越來越多

401
00:23:17,058 --> 00:23:21,960
有時我們也會主動去看想導入的 Pull Request

402
00:23:21,960 --> 00:23:25,778
回覆：「這樣設定就沒問題喔！」這樣的 Review

403
00:23:25,778 --> 00:23:29,159
這樣的互動是有在進行的

404
00:23:29,159 --> 00:23:34,097
所以可以觀察到確實已經開始動起來了

405
00:23:34,097 --> 00:23:40,519
至於這實際讓開發團隊的生產力提升了多少

406
00:23:40,519 --> 00:23:45,597
或 UI 構建的開發體驗改善到什麼程度

407
00:23:45,597 --> 00:23:50,479
目前還在持續觀察與期待中

408
00:23:50,479 --> 00:23:51,460
謝謝您的提問

409
00:23:51,460 --> 00:23:54,858
非常感謝

410
00:23:54,858 --> 00:23:58,659
來自 Niconico 直播上的一個問題

411
00:23:58,659 --> 00:23:59,939
我來轉述一下

412
00:23:59,939 --> 00:24:02,979
關於這項嘗試的動機

413
00:24:02,979 --> 00:24:09,519
有人問：「使用 Xcode Previews 的話，
在 UI 開發上真的能節省很多時間嗎？」

414
00:24:09,519 --> 00:24:13,077
還有，「未來這方面的影響大概會是什麼樣子？」

415
00:24:13,077 --> 00:24:21,160
是的，關於使用 Preview 是否能加快 UI 開發的部分

416
00:24:21,160 --> 00:24:28,939
先說，LINE app，若進行 Clean Build

417
00:24:28,939 --> 00:24:30,920
子專案的 Build 也很久

418
00:24:30,920 --> 00:24:36,337
Clean Build 有時要十幾分鐘，甚至更久

419
00:24:36,337 --> 00:24:46,598
就算只是改某個特定模組的 UI，重新 Build app 也得花上好幾分鐘

420
00:24:46,598 --> 00:24:55,618
因此，在我們這種大型 app 中，
從 UI 調整到 app 啟動這段流程特別耗時

421
00:24:56,019 --> 00:25:02,519
能夠盡量減少這些動輒十幾分鐘的 Build 和執行次數

422
00:25:02,519 --> 00:25:08,019
這對提升開發體驗應該很有幫助

423
00:25:08,019 --> 00:25:11,920
我們其實早就想導入 Preview

424
00:25:11,920 --> 00:25:15,759
只是過去 Xcode 不支援，現在終於可以用了

425
00:25:15,759 --> 00:25:19,680
所以趁這個機會正式推進導入

426
00:25:19,680 --> 00:25:25,680
當然，把 app 本身瘦身這件事我們也會持續做

427
00:25:25,680 --> 00:25:29,720
但先從「能少 Build 就少 Build」這點下手

428
00:25:29,720 --> 00:25:33,298
希望透過 Preview 來達成

429
00:25:33,298 --> 00:25:35,259
好的，謝謝您的回答

430
00:25:35,259 --> 00:25:39,837
那麼 Q&A 就到這裡

431
00:25:39,837 --> 00:25:42,759
接下來進入一分鐘回饋

432
00:25:44,080 --> 00:25:54,080
翻譯：吳　俊諺
校對：Hokila
