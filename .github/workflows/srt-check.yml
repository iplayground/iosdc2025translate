name: Check SRT Format

on:
  pull_request:
    branches: [ main, master, develop ]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  validate-srt:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ # 確保在 repo 根目錄執行
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 0           

      - name: Get changed files
        id: changed-files
        shell: bash
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          git log --no-merges --name-only --pretty=format: $BASE_SHA..$HEAD_SHA \
          | grep '\.srt' | sort | uniq | perl -pe 's/\\([0-7]{3})/chr(oct($1))/ge' > changed_files_raw.txt

          REPO_ROOT=$(pwd)
          git -C "$REPO_ROOT" -c core.quotePath=false log \
           --no-merges --name-only --pretty=format: $BASE_SHA..$HEAD_SHA \
          | grep '\.srt' | sort | uniq | sed "s|^|$REPO_ROOT/|" \
          | perl -pe 's/\\([0-7]{3})/chr(oct($1))/ge' > changed_files.txt


          cat changed_files.txt || echo "(none)"   

          echo "CHANGED_FILES<<EOF" >> "$GITHUB_ENV"
          cat changed_files.txt >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Run SRT format check
        id: srt-check
        if: contains(env.CHANGED_FILES, '.srt')
        shell: bash
        run: |
          : > srt_report.txt
          python script/check_srt_format.py || echo "has_error=true" >> $GITHUB_ENV
          echo "SRT_REPORT_PATH=$(pwd)/srt_report.txt" >> $GITHUB_ENV

      # 若有錯誤則留言在 PR 上
      - name: Comment on PR if failed
        if: env.has_error == 'true' && hashFiles('**/srt_report.txt') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: SRT Format Report
          path: ${{ env.SRT_REPORT_PATH }}
          recreate: true
          hide_classify: OUTDATED

      # 若有錯誤則讓 PR 無法 merge
      - name: Fail if has_error
        if: env.has_error == 'true'
        run: |
          echo "❌ SRT validation failed."
          exit 1
