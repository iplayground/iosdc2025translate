name: Check SRT Format

on:
  pull_request:
    branches: [ main, master, develop ]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  validate-srt:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ # ç¢ºä¿åœ¨ repo æ ¹ç›®éŒ„åŸ·è¡Œ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Get changed files
        id: changed-files
        shell: bash
        run: |
          echo "ğŸ” Fetching base branch: ${{ github.base_ref }}"
          git fetch --no-tags --prune --depth=50 origin ${{ github.base_ref }}

          # æŠ“å‡ºæ”¹å‹•æª”æ¡ˆï¼ˆç›¡é‡åˆ¥è®“ fallback èª¤è§¸ï¼‰
          if git merge-base --is-ancestor origin/${{ github.base_ref }} HEAD 2>/dev/null; then
            git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          else
            echo "âš ï¸ No merge base found, unable to compute diff."
            echo "" > changed_files.txt
          fi

          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          cat changed_files.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "Changed files:"
          cat changed_files.txt

      # åŸ·è¡Œ Python æª¢æŸ¥è…³æœ¬
      - name: Run SRT format check
        id: srt-check
        if: contains(env.CHANGED_FILES, '.srt')
        shell: bash
        run: |
          : > srt_report.txt
          python script/check_srt_format.py || echo "has_error=true" >> $GITHUB_ENV
          echo "SRT_REPORT_PATH=$(pwd)/srt_report.txt" >> $GITHUB_ENV

      - name: Skip check if no .srt changed
        if: "!contains(env.CHANGED_FILES, '.srt')"
        run: echo "â„¹ï¸ No .srt files changed, skipping validation."

      # åˆ—å‡ºå ±å‘Šå…§å®¹èˆ‡ç›®éŒ„çµæ§‹ï¼Œæ–¹ä¾¿åµéŒ¯
      - name: Debug report file
        if: always()
        shell: bash
        run: |
          echo "---- Workspace directory ----"
          pwd
          echo "---- Files in current folder ----"
          ls -al
          echo "---- Report content ----"
          if [ -f "$SRT_REPORT_PATH" ]; then
            cat "$SRT_REPORT_PATH"
            ls -lh "$SRT_REPORT_PATH"
          else
            echo "(srt_report.txt not found)"
          fi
          echo "--------------------------"

      # è‹¥æœ‰éŒ¯èª¤å‰‡ç•™è¨€åœ¨ PR ä¸Š
      - name: Comment on PR if failed
        if: env.has_error == 'true' && hashFiles('**/srt_report.txt') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: SRT Format Report
          path: ${{ env.SRT_REPORT_PATH }}
          recreate: true
          hide_classify: OUTDATED

      # è‹¥æœ‰éŒ¯èª¤å‰‡è®“ PR ç„¡æ³• merge
      - name: Fail if has_error
        if: env.has_error == 'true'
        run: |
          echo "âŒ SRT validation failed."
          exit 1
